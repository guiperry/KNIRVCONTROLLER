var Ui=Object.defineProperty;var vn=t=>{throw TypeError(t)};var Vi=(t,e,r)=>e in t?Ui(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var Ce=(t,e,r)=>Vi(t,typeof e!="symbol"?e+"":e,r),yn=(t,e,r)=>e.has(t)||vn("Cannot "+r);var v=(t,e,r)=>(yn(t,e,"read from private field"),r?r.call(t):e.get(t)),S=(t,e,r)=>e.has(t)?vn("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),C=(t,e,r,n)=>(yn(t,e,"write to private field"),n?n.call(t,r):e.set(t,r),r);var ke,nt,It,$,xe,ot,ft,Pt,Kt,Ut,Oe,Ee,Vt,it,dt,H,st,Jt,pt,St;import{_ as je,a as Ct,b as jt,c as yt,d as Ji,e as gn,f as cr,g as Gi,h as Yi}from"./blockchain-DRtzGIWH.js";function Yt(t){"@babel/helpers - typeof";return Yt=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Yt(t)}function Zi(t,e){if(Yt(t)!="object"||!t)return t;var r=t[Symbol.toPrimitive];if(r!==void 0){var n=r.call(t,e);if(Yt(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}function Xi(t){var e=Zi(t,"string");return Yt(e)=="symbol"?e:e+""}function ts(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Xi(n.key),n)}}function at(t,e,r){return e&&ts(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function bn(t){return Array.isArray(t)?t.slice(0):[t]}function Zt(t){return Array.isArray(t)}function ur(t,e){var r=0,n=-1;for(var o of t){n=n+1;var i=e(o,n);if(i)r=r+1;else break}return r}function Rt(t,e){var r=e.length;if(r!==0){var n=t.length;t.length=n+e.length;for(var o=0;o<r;++o)t[n+o]=e[o]}}function es(t){return t.filter(function(e,r,n){return n.indexOf(e)===r})}function Xt(t){for(var e="",r=0;r<t.length;r++){var n=t[r];if(n==="-")return parseInt(e,10);e+=n}throw new Error("malformatted revision: "+t)}function lr(t,e){var r=e?Xt(e._rev)+1:1;return r+"-"+t}function wn(t){return Object.freeze(t),Object.getOwnPropertyNames(t).forEach(function(e){Object.prototype.hasOwnProperty.call(t,e)&&t[e]!==null&&(typeof t[e]=="object"||typeof t[e]=="function")&&!Object.isFrozen(t[e])&&wn(t[e])}),t}function rs(t){var e=t.split("."),r=e.length;return r===1?n=>n[t]:n=>{for(var o=n,i=0;i<r;++i){var s=e[i];if(o=o[s],typeof o>"u")return o}return o}}function _n(t){var e={};for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r))if(typeof t[r]=="object"){var n=_n(t[r]);for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[r+"."+o]=n[o])}else e[r]=t[r];return e}function T(t){return Object.assign({},t)}function ns(t){return Object.keys(t)[0]}function Re(t,e=!1){if(!t)return t;if(!e&&Array.isArray(t))return t.sort((n,o)=>typeof n=="string"&&typeof o=="string"?n.localeCompare(o):typeof n=="object"?1:-1).map(n=>Re(n,e));if(typeof t=="object"&&!Array.isArray(t)){var r={};return Object.keys(t).sort((n,o)=>n.localeCompare(o)).forEach(n=>{r[n]=Re(t[n],e)}),r}return t}function hr(t){if(!t||t===null||typeof t!="object")return t;if(Array.isArray(t)){for(var e=new Array(t.length),r=e.length;r--;)e[r]=hr(t[r]);return e}var n={};for(var o in t)n[o]=hr(t[o]);return n}var Mt=hr;function X(t,e,r){return Object.defineProperty(t,e,{get:function(){return r}}),r}function kn(t,e=""){if(typeof t!="object"||t===null)return!1;for(var r of Object.keys(t)){var n=t[r],o=e?e+"."+r:r;if(typeof n>"u")return o;if(typeof n=="object"&&n!==null){var i=kn(n,o);if(i)return i}}return!1}var xn=1;function fr(){return{lwt:xn}}function dr(){return""}function os(t){return Object.assign({},t,{_meta:void 0,_deleted:void 0,_rev:void 0})}function is(t,e,r){if(e.length!==r.length)return!1;for(var n=0,o=e.length;n<o;){var i=e[n],s=r[n];if(n++,i[t]!==s[t]||i._rev!==s._rev||i._meta.lwt!==s._meta.lwt)return!1}return!0}function te(t,e){return te=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},te(t,e)}function On(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,te(t,e)}function pr(t){return pr=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},pr(t)}function ss(t){try{return Function.toString.call(t).indexOf("[native code]")!==-1}catch{return typeof t=="function"}}function En(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(En=function(){return!!t})()}function as(t,e,r){if(En())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,e);var o=new(t.bind.apply(t,n));return r&&te(o,r.prototype),o}function Me(t){var e=typeof Map=="function"?new Map:void 0;return Me=function(r){if(r===null||!ss(r))return r;if(typeof r!="function")throw new TypeError("Super expression must either be null or a function");if(e!==void 0){if(e.has(r))return e.get(r);e.set(r,n)}function n(){return as(r,arguments,pr(this).constructor)}return n.prototype=Object.create(r.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),te(n,r)},Me(t)}var j={isDevMode(){return!1},deepFreezeWhenDevMode(t){return t},tunnelErrorMessage(t){return`
        RxDB Error-Code: `+t+`.
        Hint: Error messages are not included in RxDB core to reduce build size.
        To show the full error messages and to ensure that you do not make any mistakes when using RxDB,
        use the dev-mode plugin when you are in development mode: https://rxdb.info/dev-mode.html?console=error
        `}};function cs(t){var e="";return Object.keys(t).length===0||(e+="-".repeat(20)+`
`,e+=`Parameters:
`,e+=Object.keys(t).map(r=>{var n="[object Object]";try{r==="errors"?n=t[r].map(o=>JSON.stringify(o,Object.getOwnPropertyNames(o))):n=JSON.stringify(t[r],function(o,i){return i===void 0?null:i},2)}catch{}return r+": "+n}).join(`
`),e+=`
`),e}function Dn(t,e,r){return`
`+t+`
`+cs(r)}var us=(function(t){function e(n,o,i={}){var s,a=Dn(o,n,i);return s=t.call(this,a)||this,s.code=n,s.message=a,s.url=mr(n),s.parameters=i,s.rxdb=!0,s}On(e,t);var r=e.prototype;return r.toString=function(){return this.message},at(e,[{key:"name",get:function(){return"RxError ("+this.code+")"}},{key:"typeError",get:function(){return!1}}])})(Me(Error)),ls=(function(t){function e(n,o,i={}){var s,a=Dn(o,n,i);return s=t.call(this,a)||this,s.code=n,s.message=a,s.url=mr(n),s.parameters=i,s.rxdb=!0,s}On(e,t);var r=e.prototype;return r.toString=function(){return this.message},at(e,[{key:"name",get:function(){return"RxTypeError ("+this.code+")"}},{key:"typeError",get:function(){return!0}}])})(Me(TypeError));function mr(t){return"https://rxdb.info/errors.html?console=errors#"+t}function In(t){return`
Find out more about this error here: `+mr(t)+` 
`}function b(t,e){return new us(t,j.tunnelErrorMessage(t)+In(t),e)}function $e(t,e){return new ls(t,j.tunnelErrorMessage(t)+In(t),e)}function Pn(t){return t&&t.status===409?t:!1}var hs={409:"document write conflict",422:"schema validation error",510:"attachment data missing"};function Sn(t){return b("COL20",{name:hs[t.status],document:t.documentId,writeError:t})}var Ae;function fs(){var t;if(Ae)return Ae;if(typeof crypto>"u"||typeof crypto.subtle>"u"||typeof crypto.subtle.digest!="function")throw b("UT8",{args:{typeof_crypto:typeof crypto,typeof_crypto_subtle:typeof(crypto==null?void 0:crypto.subtle),typeof_crypto_subtle_digest:typeof((t=crypto==null?void 0:crypto.subtle)==null?void 0:t.digest)}});return Ae=crypto.subtle.digest.bind(crypto.subtle),Ae}async function ds(t){var e=new TextEncoder().encode(t),r=await fs()("SHA-256",e),n=Array.prototype.map.call(new Uint8Array(r),o=>("00"+o.toString(16)).slice(-2)).join("");return n}var Cn=ds;function ps(t){for(var e=0,r=t.length,n=0;n<r;n++)e=e+t.charCodeAt(n),e|=0;return e}function ms(){return new Promise(t=>setTimeout(t,0))}function vs(t=0){return new Promise(e=>setTimeout(e,t))}Promise.resolve(!0);var $t=Promise.resolve(!1),ys=Promise.resolve(null),qe=Promise.resolve();function Ne(t=1e4){return typeof requestIdleCallback=="function"?new Promise(e=>{requestIdleCallback(()=>e(),{timeout:t})}):vs(0)}var vr=qe;function gs(t=void 0){return vr=vr.then(()=>Ne(t)),vr}function bs(t){typeof requestIdleCallback=="function"&&requestIdleCallback(()=>{t()})}function ws(t,e){return t.reduce((r,n)=>r.then(n),Promise.resolve(e))}var _s=/\./g,jn="abcdefghijklmnopqrstuvwxyz";function Te(t=10){for(var e="",r=0;r<t;r++)e+=jn.charAt(Math.floor(Math.random()*jn.length));return e}function Rn(t){t+="";var e=t.charAt(0).toUpperCase();return e+t.substr(1)}function At(t){for(;t.charAt(0)===".";)t=t.substr(1);for(;t.slice(-1)===".";)t=t.slice(0,-1);return t}function ks(t){return!!(t.includes("/")||t.includes("\\"))}function ee(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){if(t.constructor!==e.constructor)return!1;var r,n;if(Array.isArray(t)){if(r=t.length,r!==e.length)return!1;for(n=r;n--!==0;)if(!ee(t[n],e[n]))return!1;return!0}if(t.constructor===RegExp)return t.source===e.source&&t.flags===e.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===e.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===e.toString();var o=Object.keys(t);if(r=o.length,r!==Object.keys(e).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(e,o[n]))return!1;for(n=r;n--!==0;){var i=o[n];if(!ee(t[i],e[i]))return!1}return!0}return t!==t&&e!==e}var yr=t=>{var e=typeof t;return t!==null&&(e==="object"||e==="function")},gr=new Set(["__proto__","prototype","constructor"]),xs=new Set("0123456789");function Mn(t){var e=[],r="",n="start",o=!1;for(var i of t)switch(i){case"\\":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");o&&(r+=i),n="property",o=!o;break}case".":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="property";break}if(o){o=!1,r+=i;break}if(gr.has(r))return[];e.push(r),r="",n="property";break}case"[":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="index";break}if(o){o=!1,r+=i;break}if(n==="property"){if(gr.has(r))return[];e.push(r),r=""}n="index";break}case"]":{if(n==="index"){e.push(Number.parseInt(r,10)),r="",n="indexEnd";break}if(n==="indexEnd")throw new Error("Invalid character after an index")}default:{if(n==="index"&&!xs.has(i))throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");n==="start"&&(n="property"),o&&(o=!1,r+="\\"),r+=i}}switch(o&&(r+="\\"),n){case"property":{if(gr.has(r))return[];e.push(r);break}case"index":throw new Error("Index was not closed");case"start":{e.push("");break}}return e}function $n(t,e){if(typeof e!="number"&&Array.isArray(t)){var r=Number.parseInt(e,10);return Number.isInteger(r)&&t[r]===t[e]}return!1}function Os(t,e){if($n(t,e))throw new Error("Cannot use string index")}function re(t,e,r){if(Array.isArray(e)&&(e=e.join(".")),!e.includes(".")&&!e.includes("["))return t[e];if(!yr(t)||typeof e!="string")return r===void 0?t:r;var n=Mn(e);if(n.length===0)return r;for(var o=0;o<n.length;o++){var i=n[o];if($n(t,i)?t=o===n.length-1?void 0:null:t=t[i],t==null){if(o!==n.length-1)return r;break}}return t===void 0?r:t}function Es(t,e,r){if(Array.isArray(e)&&(e=e.join(".")),!yr(t)||typeof e!="string")return t;for(var n=t,o=Mn(e),i=0;i<o.length;i++){var s=o[i];Os(t,s),i===o.length-1?t[s]=r:yr(t[s])||(t[s]=typeof o[i+1]=="number"?[]:{}),t=t[s]}return n}function Be(t,e){var r=t.get(e);if(typeof r>"u")throw new Error("missing value from map "+e);return r}function G(t,e,r,n){var o=t.get(e);return typeof o>"u"&&(o=r(),t.set(e,o)),o}function E(t){var e=t.split("-"),r="RxDB";return e.forEach(n=>{r+=Rn(n)}),r+="Plugin",new Error(`You are using a function which must be overwritten by a plugin.
        You should either prevent the usage of this function or add the plugin via:
            import { `+r+" } from 'rxdb/plugins/"+t+`';
            addRxPlugin(`+r+`);
        `)}var br=0;function gt(){var t=Date.now();t=t+.01,t<=br&&(t=br+.01);var e=parseFloat(t.toFixed(2));return br=e,e}function P(t,e){if(!t)throw e||(e=""),new Error("ensureNotFalsy() is falsy: "+e);return t}var An={bufferSize:1,refCount:!0},qn="16.18.0",wr={},Ds="6da4936d1425ff3a5c44c02342c6daf791d266be3ae8479b8ec59e261df41b93",_r=16,Nn=$t,Tn=!1;async function Bn(){return Tn||(Tn=!0,Nn=(async()=>!!(wr.premium&&typeof wr.premium=="string"&&await Cn(wr.premium)===Ds))()),Nn}var ne={preAddRxPlugin:[],preCreateRxDatabase:[],createRxDatabase:[],preCreateRxCollection:[],createRxCollection:[],createRxState:[],postCloseRxCollection:[],postRemoveRxCollection:[],preCreateRxSchema:[],createRxSchema:[],prePrepareRxQuery:[],preCreateRxQuery:[],prePrepareQuery:[],createRxDocument:[],postCreateRxDocument:[],preCreateRxStorageInstance:[],preStorageWrite:[],preMigrateDocument:[],postMigrateDocument:[],preCloseRxDatabase:[],postRemoveRxDatabase:[],postCleanup:[],preReplicationMasterWrite:[],preReplicationMasterWriteDocumentsHandle:[]};function B(t,e){ne[t].length>0&&ne[t].forEach(r=>r(e))}async function oe(t,e){for(var r of ne[t])await r(e)}function ie(t,e){var r=e;r=r.replace(_s,".properties."),r="properties."+r,r=At(r);var n=re(t,r);return n}function Ln(t,e,r){if(typeof e.primaryKey=="string")return r;var n=kr(e,r),o=r[t];if(o&&o!==n)throw b("DOC19",{args:{documentData:r,existingPrimary:o,newPrimary:n},schema:e});return r[t]=n,r}function bt(t){return typeof t=="string"?t:t.key}function kr(t,e){if(typeof t.primaryKey=="string")return e[t.primaryKey];var r=t.primaryKey;return r.fields.map(n=>{var o=re(e,n);if(typeof o>"u")throw b("DOC18",{args:{field:n,documentData:e}});return o}).join(r.separator)}function Is(t){var e=Re(t,!0);return e}function Ps(t){return["_deleted",t]}function Fn(t){t=T(t);var e=bt(t.primaryKey);t.properties=T(t.properties),t.additionalProperties=!1,Object.prototype.hasOwnProperty.call(t,"keyCompression")||(t.keyCompression=!1),t.indexes=t.indexes?t.indexes.slice(0):[],t.required=t.required?t.required.slice(0):[],t.encrypted=t.encrypted?t.encrypted.slice(0):[],t.properties._rev={type:"string",minLength:1},t.properties._attachments={type:"object"},t.properties._deleted={type:"boolean"},t.properties._meta=Cs,t.required=t.required?t.required.slice(0):[],t.required.push("_deleted"),t.required.push("_rev"),t.required.push("_meta"),t.required.push("_attachments");var r=Qn(t);Rt(t.required,r),t.required=t.required.filter(i=>!i.includes(".")).filter((i,s,a)=>a.indexOf(i)===s),t.version=t.version||0;var n=t.indexes.map(i=>{var s=Zt(i)?i.slice(0):[i];return s.includes(e)||s.push(e),s[0]!=="_deleted"&&s.unshift("_deleted"),s});n.length===0&&n.push(Ps(e)),n.push(["_meta.lwt",e]),t.internalIndexes&&t.internalIndexes.map(i=>{n.push(i)});var o=new Set;return n.filter(i=>{var s=i.join(",");return o.has(s)?!1:(o.add(s),!0)}),t.indexes=n,t}var Ss=1e15,Cs={type:"object",properties:{lwt:{type:"number",minimum:xn,maximum:Ss,multipleOf:.01}},additionalProperties:!0,required:["lwt"]};function Qn(t){var e=Object.keys(t.properties).filter(n=>t.properties[n].final),r=bt(t.primaryKey);return e.push(r),typeof t.primaryKey!="string"&&t.primaryKey.fields.forEach(n=>e.push(n)),e}function js(t,e){for(var r=Object.keys(t.defaultValues),n=0;n<r.length;++n){var o=r[n];(!Object.prototype.hasOwnProperty.call(e,o)||typeof e[o]>"u")&&(e[o]=t.defaultValues[o])}return e}var Wn=(function(){function t(r,n){if(this.jsonSchema=r,this.hashFunction=n,this.indexes=Rs(this.jsonSchema),this.primaryPath=bt(this.jsonSchema.primaryKey),!r.properties[this.primaryPath].maxLength)throw b("SC39",{schema:r});this.finalFields=Qn(this.jsonSchema)}var e=t.prototype;return e.validateChange=function(r,n){this.finalFields.forEach(o=>{if(!ee(r[o],n[o]))throw b("DOC9",{dataBefore:r,dataAfter:n,fieldName:o,schema:this.jsonSchema})})},e.getDocumentPrototype=function(){var r={},n=ie(this.jsonSchema,"");return Object.keys(n).forEach(o=>{var i=o;r.__defineGetter__(o,function(){if(!(!this.get||typeof this.get!="function")){var s=this.get(i);return s}}),Object.defineProperty(r,o+"$",{get:function(){return this.get$(i)},enumerable:!1,configurable:!1}),Object.defineProperty(r,o+"$$",{get:function(){return this.get$$(i)},enumerable:!1,configurable:!1}),Object.defineProperty(r,o+"_",{get:function(){return this.populate(i)},enumerable:!1,configurable:!1})}),X(this,"getDocumentPrototype",()=>r),r},e.getPrimaryOfDocumentData=function(r){return kr(this.jsonSchema,r)},at(t,[{key:"version",get:function(){return this.jsonSchema.version}},{key:"defaultValues",get:function(){var r={};return Object.entries(this.jsonSchema.properties).filter(([,n])=>Object.prototype.hasOwnProperty.call(n,"default")).forEach(([n,o])=>r[n]=o.default),X(this,"defaultValues",r)}},{key:"hash",get:function(){return X(this,"hash",this.hashFunction(JSON.stringify(this.jsonSchema)))}}])})();function Rs(t){return(t.indexes||[]).map(e=>Zt(e)?e:[e])}function Ms(t){var e=t.version?t.version:0,r=0;return new Array(e).fill(0).map(()=>r++)}function $s(t,e,r=!0){r&&B("preCreateRxSchema",t);var n=Fn(t);n=Is(n),j.deepFreezeWhenDevMode(n);var o=new Wn(n,e);return B("createRxSchema",o),o}function R(t){return typeof t=="function"}function As(t){return R(t==null?void 0:t.lift)}function tt(t){return function(e){if(As(e))return e.lift(function(r){try{return t(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}var zn=(function(t){return t&&typeof t.length=="number"&&typeof t!="function"});function Hn(t){return R(t==null?void 0:t.then)}function Kn(t){var e=function(n){Error.call(n),n.stack=new Error().stack},r=t(e);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var xr=Kn(function(t){return function(e){t(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(r,n){return n+1+") "+r.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function Or(t,e){if(t){var r=t.indexOf(e);0<=r&&t.splice(r,1)}}var Le=(function(){function t(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return t.prototype.unsubscribe=function(){var e,r,n,o,i;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var a=je(s),c=a.next();!c.done;c=a.next()){var l=c.value;l.remove(this)}}catch(m){e={error:m}}finally{try{c&&!c.done&&(r=a.return)&&r.call(a)}finally{if(e)throw e.error}}else s.remove(this);var u=this.initialTeardown;if(R(u))try{u()}catch(m){i=m instanceof xr?m.errors:[m]}var h=this._finalizers;if(h){this._finalizers=null;try{for(var f=je(h),d=f.next();!d.done;d=f.next()){var p=d.value;try{Jn(p)}catch(m){i=i??[],m instanceof xr?i=Ct(Ct([],jt(i)),jt(m.errors)):i.push(m)}}}catch(m){n={error:m}}finally{try{d&&!d.done&&(o=f.return)&&o.call(f)}finally{if(n)throw n.error}}}if(i)throw new xr(i)}},t.prototype.add=function(e){var r;if(e&&e!==this)if(this.closed)Jn(e);else{if(e instanceof t){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(r=this._finalizers)!==null&&r!==void 0?r:[]).push(e)}},t.prototype._hasParent=function(e){var r=this._parentage;return r===e||Array.isArray(r)&&r.includes(e)},t.prototype._addParent=function(e){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(e),r):r?[r,e]:e},t.prototype._removeParent=function(e){var r=this._parentage;r===e?this._parentage=null:Array.isArray(r)&&Or(r,e)},t.prototype.remove=function(e){var r=this._finalizers;r&&Or(r,e),e instanceof t&&e._removeParent(this)},t.EMPTY=(function(){var e=new t;return e.closed=!0,e})(),t})(),Un=Le.EMPTY;function Vn(t){return t instanceof Le||t&&"closed"in t&&R(t.remove)&&R(t.add)&&R(t.unsubscribe)}function Jn(t){R(t)?t():t.unsubscribe()}var qs={Promise:void 0},Ns={setTimeout:function(t,e){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];return setTimeout.apply(void 0,Ct([t,e],jt(r)))},clearTimeout:function(t){return clearTimeout(t)},delegate:void 0};function Gn(t){Ns.setTimeout(function(){throw t})}function Yn(){}function Fe(t){t()}var Er=(function(t){yt(e,t);function e(r){var n=t.call(this)||this;return n.isStopped=!1,r?(n.destination=r,Vn(r)&&r.add(n)):n.destination=Ls,n}return e.create=function(r,n,o){return new se(r,n,o)},e.prototype.next=function(r){this.isStopped||this._next(r)},e.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(r){this.destination.next(r)},e.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e})(Le),Ts=(function(){function t(e){this.partialObserver=e}return t.prototype.next=function(e){var r=this.partialObserver;if(r.next)try{r.next(e)}catch(n){Qe(n)}},t.prototype.error=function(e){var r=this.partialObserver;if(r.error)try{r.error(e)}catch(n){Qe(n)}else Qe(e)},t.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(r){Qe(r)}},t})(),se=(function(t){yt(e,t);function e(r,n,o){var i=t.call(this)||this,s;return R(r)||!r?s={next:r??void 0,error:n??void 0,complete:o??void 0}:s=r,i.destination=new Ts(s),i}return e})(Er);function Qe(t){Gn(t)}function Bs(t){throw t}var Ls={closed:!0,next:Yn,error:Bs,complete:Yn},Dr=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function Ir(t){return t}function Fs(t){return t.length===0?Ir:t.length===1?t[0]:function(e){return t.reduce(function(r,n){return n(r)},e)}}var K=(function(){function t(e){e&&(this._subscribe=e)}return t.prototype.lift=function(e){var r=new t;return r.source=this,r.operator=e,r},t.prototype.subscribe=function(e,r,n){var o=this,i=Ws(e)?e:new se(e,r,n);return Fe(function(){var s=o,a=s.operator,c=s.source;i.add(a?a.call(i,c):c?o._subscribe(i):o._trySubscribe(i))}),i},t.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(r){e.error(r)}},t.prototype.forEach=function(e,r){var n=this;return r=Zn(r),new r(function(o,i){var s=new se({next:function(a){try{e(a)}catch(c){i(c),s.unsubscribe()}},error:i,complete:o});n.subscribe(s)})},t.prototype._subscribe=function(e){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(e)},t.prototype[Dr]=function(){return this},t.prototype.pipe=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return Fs(e)(this)},t.prototype.toPromise=function(e){var r=this;return e=Zn(e),new e(function(n,o){var i;r.subscribe(function(s){return i=s},function(s){return o(s)},function(){return n(i)})})},t.create=function(e){return new t(e)},t})();function Zn(t){var e;return(e=t??qs.Promise)!==null&&e!==void 0?e:Promise}function Qs(t){return t&&R(t.next)&&R(t.error)&&R(t.complete)}function Ws(t){return t&&t instanceof Er||Qs(t)&&Vn(t)}function Xn(t){return R(t[Dr])}function to(t){return Symbol.asyncIterator&&R(t==null?void 0:t[Symbol.asyncIterator])}function eo(t){return new TypeError("You provided "+(t!==null&&typeof t=="object"?"an invalid object":"'"+t+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function zs(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var ro=zs();function no(t){return R(t==null?void 0:t[ro])}function oo(t){return Ji(this,arguments,function(){var e,r,n,o;return gn(this,function(i){switch(i.label){case 0:e=t.getReader(),i.label=1;case 1:i.trys.push([1,,9,10]),i.label=2;case 2:return[4,cr(e.read())];case 3:return r=i.sent(),n=r.value,o=r.done,o?[4,cr(void 0)]:[3,5];case 4:return[2,i.sent()];case 5:return[4,cr(n)];case 6:return[4,i.sent()];case 7:return i.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function io(t){return R(t==null?void 0:t.getReader)}function ct(t){if(t instanceof K)return t;if(t!=null){if(Xn(t))return Hs(t);if(zn(t))return Ks(t);if(Hn(t))return Us(t);if(to(t))return so(t);if(no(t))return Vs(t);if(io(t))return Js(t)}throw eo(t)}function Hs(t){return new K(function(e){var r=t[Dr]();if(R(r.subscribe))return r.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Ks(t){return new K(function(e){for(var r=0;r<t.length&&!e.closed;r++)e.next(t[r]);e.complete()})}function Us(t){return new K(function(e){t.then(function(r){e.closed||(e.next(r),e.complete())},function(r){return e.error(r)}).then(null,Gn)})}function Vs(t){return new K(function(e){var r,n;try{for(var o=je(t),i=o.next();!i.done;i=o.next()){var s=i.value;if(e.next(s),e.closed)return}}catch(a){r={error:a}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}e.complete()})}function so(t){return new K(function(e){Gs(t,e).catch(function(r){return e.error(r)})})}function Js(t){return so(oo(t))}function Gs(t,e){var r,n,o,i;return Gi(this,void 0,void 0,function(){var s,a;return gn(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),r=Yi(t),c.label=1;case 1:return[4,r.next()];case 2:if(n=c.sent(),!!n.done)return[3,4];if(s=n.value,e.next(s),e.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=c.sent(),o={error:a},[3,11];case 6:return c.trys.push([6,,9,10]),n&&!n.done&&(i=r.return)?[4,i.call(r)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function qt(t,e,r,n,o){return new Ys(t,e,r,n,o)}var Ys=(function(t){yt(e,t);function e(r,n,o,i,s,a){var c=t.call(this,r)||this;return c.onFinalize=s,c.shouldUnsubscribe=a,c._next=n?function(l){try{n(l)}catch(u){r.error(u)}}:t.prototype._next,c._error=i?function(l){try{i(l)}catch(u){r.error(u)}finally{this.unsubscribe()}}:t.prototype._error,c._complete=o?function(){try{o()}catch(l){r.error(l)}finally{this.unsubscribe()}}:t.prototype._complete,c}return e.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;t.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},e})(Er),ao={now:function(){return(ao.delegate||Date).now()},delegate:void 0};function Zs(t){return t&&R(t.schedule)}function co(t){return t[t.length-1]}function We(t){return Zs(co(t))?t.pop():void 0}function uo(t,e){return typeof co(t)=="number"?t.pop():e}function wt(t,e,r,n,o){n===void 0&&(n=0),o===void 0&&(o=!1);var i=e.schedule(function(){r(),o?t.add(this.schedule(null,n)):this.unsubscribe()},n);if(t.add(i),!o)return i}function lo(t,e){return e===void 0&&(e=0),tt(function(r,n){r.subscribe(qt(n,function(o){return wt(n,t,function(){return n.next(o)},e)},function(){return wt(n,t,function(){return n.complete()},e)},function(o){return wt(n,t,function(){return n.error(o)},e)}))})}function ho(t,e){return e===void 0&&(e=0),tt(function(r,n){n.add(t.schedule(function(){return r.subscribe(n)},e))})}function Xs(t,e){return ct(t).pipe(ho(e),lo(e))}function ta(t,e){return ct(t).pipe(ho(e),lo(e))}function ea(t,e){return new K(function(r){var n=0;return e.schedule(function(){n===t.length?r.complete():(r.next(t[n++]),r.closed||this.schedule())})})}function ra(t,e){return new K(function(r){var n;return wt(r,e,function(){n=t[ro](),wt(r,e,function(){var o,i,s;try{o=n.next(),i=o.value,s=o.done}catch(a){r.error(a);return}s?r.complete():r.next(i)},0,!0)}),function(){return R(n==null?void 0:n.return)&&n.return()}})}function fo(t,e){if(!t)throw new Error("Iterable cannot be null");return new K(function(r){wt(r,e,function(){var n=t[Symbol.asyncIterator]();wt(r,e,function(){n.next().then(function(o){o.done?r.complete():r.next(o.value)})},0,!0)})})}function na(t,e){return fo(oo(t),e)}function oa(t,e){if(t!=null){if(Xn(t))return Xs(t,e);if(zn(t))return ea(t,e);if(Hn(t))return ta(t,e);if(to(t))return fo(t,e);if(no(t))return ra(t,e);if(io(t))return na(t,e)}throw eo(t)}function Pr(t,e){return e?oa(t,e):ct(t)}function Z(t,e){return tt(function(r,n){var o=0;r.subscribe(qt(n,function(i){n.next(t.call(e,i,o++))}))})}function ia(t,e,r,n,o,i,s,a){var c=[],l=0,u=0,h=!1,f=function(){h&&!c.length&&!l&&e.complete()},d=function(m){return l<n?p(m):c.push(m)},p=function(m){l++;var y=!1;ct(r(m,u++)).subscribe(qt(e,function(g){e.next(g)},function(){y=!0},void 0,function(){if(y)try{l--;for(var g=function(){var w=c.shift();s||p(w)};c.length&&l<n;)g();f()}catch(w){e.error(w)}}))};return t.subscribe(qt(e,d,function(){h=!0,f()})),function(){}}function ae(t,e,r){return r===void 0&&(r=1/0),R(e)?ae(function(n,o){return Z(function(i,s){return e(n,i,o,s)})(ct(t(n,o)))},r):(typeof e=="number"&&(r=e),tt(function(n,o){return ia(n,o,t,r)}))}function Sr(t){return t===void 0&&(t=1/0),ae(Ir,t)}function sa(){return Sr(1)}var aa=Kn(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),_t=(function(t){yt(e,t);function e(){var r=t.call(this)||this;return r.closed=!1,r.currentObservers=null,r.observers=[],r.isStopped=!1,r.hasError=!1,r.thrownError=null,r}return e.prototype.lift=function(r){var n=new po(this,this);return n.operator=r,n},e.prototype._throwIfClosed=function(){if(this.closed)throw new aa},e.prototype.next=function(r){var n=this;Fe(function(){var o,i;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var s=je(n.currentObservers),a=s.next();!a.done;a=s.next()){var c=a.value;c.next(r)}}catch(l){o={error:l}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(o)throw o.error}}}})},e.prototype.error=function(r){var n=this;Fe(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=r;for(var o=n.observers;o.length;)o.shift().error(r)}})},e.prototype.complete=function(){var r=this;Fe(function(){if(r._throwIfClosed(),!r.isStopped){r.isStopped=!0;for(var n=r.observers;n.length;)n.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var r;return((r=this.observers)===null||r===void 0?void 0:r.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(r){return this._throwIfClosed(),t.prototype._trySubscribe.call(this,r)},e.prototype._subscribe=function(r){return this._throwIfClosed(),this._checkFinalizedStatuses(r),this._innerSubscribe(r)},e.prototype._innerSubscribe=function(r){var n=this,o=this,i=o.hasError,s=o.isStopped,a=o.observers;return i||s?Un:(this.currentObservers=null,a.push(r),new Le(function(){n.currentObservers=null,Or(a,r)}))},e.prototype._checkFinalizedStatuses=function(r){var n=this,o=n.hasError,i=n.thrownError,s=n.isStopped;o?r.error(i):s&&r.complete()},e.prototype.asObservable=function(){var r=new K;return r.source=this,r},e.create=function(r,n){return new po(r,n)},e})(K),po=(function(t){yt(e,t);function e(r,n){var o=t.call(this)||this;return o.destination=r,o.source=n,o}return e.prototype.next=function(r){var n,o;(o=(n=this.destination)===null||n===void 0?void 0:n.next)===null||o===void 0||o.call(n,r)},e.prototype.error=function(r){var n,o;(o=(n=this.destination)===null||n===void 0?void 0:n.error)===null||o===void 0||o.call(n,r)},e.prototype.complete=function(){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.complete)===null||n===void 0||n.call(r)},e.prototype._subscribe=function(r){var n,o;return(o=(n=this.source)===null||n===void 0?void 0:n.subscribe(r))!==null&&o!==void 0?o:Un},e})(_t);function mo(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return sa()(Pr(t,We(t)))}var ca=new K(function(t){return t.complete()});function Cr(t,e){return e===void 0&&(e=Ir),t=t??ua,tt(function(r,n){var o,i=!0;r.subscribe(qt(n,function(s){var a=e(s);(i||!t(o,a))&&(i=!1,o=a,n.next(s))}))})}function ua(t,e){return t===e}function U(t,e){return tt(function(r,n){var o=0;r.subscribe(qt(n,function(i){return t.call(e,i,o++)&&n.next(i)}))})}function la(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=We(t),n=uo(t,1/0);return tt(function(o,i){Sr(n)(Pr(Ct([o],jt(t)),r)).subscribe(i)})}function ha(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return la.apply(void 0,Ct([],jt(t)))}var fa=(function(t){yt(e,t);function e(r){var n=t.call(this)||this;return n._value=r,n}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(r){var n=t.prototype._subscribe.call(this,r);return!n.closed&&r.next(this._value),n},e.prototype.getValue=function(){var r=this,n=r.hasError,o=r.thrownError,i=r._value;if(n)throw o;return this._throwIfClosed(),i},e.prototype.next=function(r){t.prototype.next.call(this,this._value=r)},e})(_t),da=(function(t){yt(e,t);function e(r,n,o){r===void 0&&(r=1/0),n===void 0&&(n=1/0),o===void 0&&(o=ao);var i=t.call(this)||this;return i._bufferSize=r,i._windowTime=n,i._timestampProvider=o,i._buffer=[],i._infiniteTimeWindow=!0,i._infiniteTimeWindow=n===1/0,i._bufferSize=Math.max(1,r),i._windowTime=Math.max(1,n),i}return e.prototype.next=function(r){var n=this,o=n.isStopped,i=n._buffer,s=n._infiniteTimeWindow,a=n._timestampProvider,c=n._windowTime;o||(i.push(r),!s&&i.push(a.now()+c)),this._trimBuffer(),t.prototype.next.call(this,r)},e.prototype._subscribe=function(r){this._throwIfClosed(),this._trimBuffer();for(var n=this._innerSubscribe(r),o=this,i=o._infiniteTimeWindow,s=o._buffer,a=s.slice(),c=0;c<a.length&&!r.closed;c+=i?1:2)r.next(a[c]);return this._checkFinalizedStatuses(r),n},e.prototype._trimBuffer=function(){var r=this,n=r._bufferSize,o=r._timestampProvider,i=r._buffer,s=r._infiniteTimeWindow,a=(s?1:2)*n;if(n<1/0&&a<i.length&&i.splice(0,i.length-a),!s){for(var c=o.now(),l=0,u=1;u<i.length&&i[u]<=c;u+=2)l=u;l&&i.splice(0,l+1)}},e})(_t);function pa(t){t===void 0&&(t={});var e=t.connector,r=e===void 0?function(){return new _t}:e,n=t.resetOnError,o=n===void 0?!0:n,i=t.resetOnComplete,s=i===void 0?!0:i,a=t.resetOnRefCountZero,c=a===void 0?!0:a;return function(l){var u,h,f,d=0,p=!1,m=!1,y=function(){h==null||h.unsubscribe(),h=void 0},g=function(){y(),u=f=void 0,p=m=!1},w=function(){var _=u;g(),_==null||_.unsubscribe()};return tt(function(_,A){d++,!m&&!p&&y();var x=f=f??r();A.add(function(){d--,d===0&&!m&&!p&&(h=jr(w,c))}),x.subscribe(A),!u&&d>0&&(u=new se({next:function(k){return x.next(k)},error:function(k){m=!0,y(),h=jr(g,o,k),x.error(k)},complete:function(){p=!0,y(),h=jr(g,s),x.complete()}}),ct(_).subscribe(u))})(l)}}function jr(t,e){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];if(e===!0){t();return}if(e!==!1){var o=new se({next:function(){o.unsubscribe(),t()}});return ct(e.apply(void 0,Ct([],jt(r)))).subscribe(o)}}function vo(t,e,r){var n,o,i,s,a=!1;return t&&typeof t=="object"?(n=t.bufferSize,s=n===void 0?1/0:n,o=t.windowTime,e=o===void 0?1/0:o,i=t.refCount,a=i===void 0?!1:i,r=t.scheduler):s=t??1/0,pa({connector:function(){return new da(s,e,r)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:a})}function yo(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=We(t);return tt(function(n,o){(r?mo(t,n,r):mo(t,n)).subscribe(o)})}function ma(t){return t.documentData?t.documentData:t.previousDocumentData}function va(t){switch(t.operation){case"INSERT":return{operation:t.operation,id:t.documentId,doc:t.documentData,previous:null};case"UPDATE":return{operation:t.operation,id:t.documentId,doc:j.deepFreezeWhenDevMode(t.documentData),previous:t.previousDocumentData?t.previousDocumentData:"UNKNOWN"};case"DELETE":return{operation:t.operation,id:t.documentId,doc:null,previous:t.previousDocumentData}}}var ya=new Map;function go(t){return G(ya,t,()=>{for(var e=new Array(t.events.length),r=t.events,n=t.collectionName,o=t.isLocal,i=j.deepFreezeWhenDevMode,s=0;s<r.length;s++){var a=r[s];e[s]={documentId:a.documentId,collectionName:n,isLocal:o,operation:a.operation,documentData:i(a.documentData),previousDocumentData:i(a.previousDocumentData)}}return e})}function ga(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=We(t),n=uo(t,1/0),o=t;return o.length?o.length===1?ct(o[0]):Sr(n)(Pr(o,r)):ca}var Nt="\uFFFF",Tt=Number.MIN_SAFE_INTEGER;function ba(t,e){var r=e.selector,n=t.indexes?t.indexes.slice(0):[];e.index&&(n=[e.index]);var o=!!e.sort.find(u=>Object.values(u)[0]==="desc"),i=new Set;Object.keys(r).forEach(u=>{var h=ie(t,u);h&&h.type==="boolean"&&Object.prototype.hasOwnProperty.call(r[u],"$eq")&&i.add(u)});var s=e.sort.map(u=>Object.keys(u)[0]),a=s.filter(u=>!i.has(u)).join(","),c=-1,l;if(n.forEach(u=>{var h=!0,f=!0,d=u.map(w=>{var _=r[w],A=_?Object.keys(_):[],x={};if(!_||!A.length){var k=f?Tt:Nt;x={startKey:k,endKey:h?Nt:Tt,inclusiveStart:!0,inclusiveEnd:!0}}else A.forEach(D=>{if(Rr.has(D)){var I=_[D],N=xa(D,I);x=Object.assign(x,N)}});return typeof x.startKey>"u"&&(x.startKey=Tt),typeof x.endKey>"u"&&(x.endKey=Nt),typeof x.inclusiveStart>"u"&&(x.inclusiveStart=!0),typeof x.inclusiveEnd>"u"&&(x.inclusiveEnd=!0),f&&!x.inclusiveStart&&(f=!1),h&&!x.inclusiveEnd&&(h=!1),x}),p=d.map(w=>w.startKey),m=d.map(w=>w.endKey),y={index:u,startKeys:p,endKeys:m,inclusiveEnd:h,inclusiveStart:f,sortSatisfiedByIndex:!o&&a===u.filter(w=>!i.has(w)).join(","),selectorSatisfiedByIndex:ka(u,e.selector,p,m)},g=Oa(t,e,y);(g>=c||e.index)&&(c=g,l=y)}),!l)throw b("SNH",{query:e});return l}var Rr=new Set(["$eq","$gt","$gte","$lt","$lte"]),wa=new Set(["$eq","$gt","$gte"]),_a=new Set(["$eq","$lt","$lte"]);function ka(t,e,r,n){var o=Object.entries(e),i=o.find(([D,I])=>{if(!t.includes(D))return!0;var N=Object.entries(I).find(([mt,sr])=>!Rr.has(mt));return N});if(i||e.$and||e.$or)return!1;var s=[],a=new Set;for(var[c,l]of Object.entries(e)){if(!t.includes(c))return!1;var u=Object.keys(l).filter(D=>wa.has(D));if(u.length>1)return!1;var h=u[0];if(h&&a.add(c),h!=="$eq"){if(s.length>0)return!1;s.push(h)}}var f=[],d=new Set;for(var[p,m]of Object.entries(e)){if(!t.includes(p))return!1;var y=Object.keys(m).filter(D=>_a.has(D));if(y.length>1)return!1;var g=y[0];if(g&&d.add(p),g!=="$eq"){if(f.length>0)return!1;f.push(g)}}var w=0;for(var _ of t){for(var A of[a,d]){if(!A.has(_)&&A.size>0)return!1;A.delete(_)}var x=r[w],k=n[w];if(x!==k&&a.size>0&&d.size>0)return!1;w++}return!0}function xa(t,e){switch(t){case"$eq":return{startKey:e,endKey:e,inclusiveEnd:!0,inclusiveStart:!0};case"$lte":return{endKey:e,inclusiveEnd:!0};case"$gte":return{startKey:e,inclusiveStart:!0};case"$lt":return{endKey:e,inclusiveEnd:!1};case"$gt":return{startKey:e,inclusiveStart:!1};default:throw new Error("SNH")}}function Oa(t,e,r){var n=0,o=u=>{u>0&&(n=n+u)},i=10,s=ur(r.startKeys,u=>u!==Tt&&u!==Nt);o(s*i);var a=ur(r.startKeys,u=>u!==Nt&&u!==Tt);o(a*i);var c=ur(r.startKeys,(u,h)=>u===r.endKeys[h]);o(c*i*1.5);var l=r.sortSatisfiedByIndex?5:0;return o(l),n}class ze extends Error{}const ce=Symbol("missing"),bo=Object.freeze(new Error("mingo: cycle detected while processing object/array")),He=t=>{const e=Ue(t);let r=0,n=e.length;for(;n;)r=(r<<5)-r^e.charCodeAt(--n);return r>>>0},ut=t=>typeof t!="object"&&typeof t!="function"||t===null,wo=t=>ut(t)||le(t)||kt(t),_o={undefined:1,null:2,number:3,string:4,symbol:5,object:6,array:7,arraybuffer:8,boolean:9,date:10,regexp:11,function:12},lt=(t,e)=>{t===ce&&(t=void 0),e===ce&&(e=void 0);const[r,n]=[t,e].map(o=>_o[ue(o)]||0);return r!==n?r-n:ht(t,e)?0:t<e?-1:t>e?1:0},mn=class mn extends Map{constructor(){super();S(this,ke,He);S(this,nt,new Map);S(this,It,r=>{const n=v(this,ke).call(this,r);return[(v(this,nt).get(n)||[]).find(o=>ht(o,r)),n]})}static init(r){const n=new mn;return r&&C(n,ke,r),n}clear(){super.clear(),v(this,nt).clear()}delete(r){if(ut(r))return super.delete(r);const[n,o]=v(this,It).call(this,r);return super.delete(n)?(v(this,nt).set(o,v(this,nt).get(o).filter(i=>!ht(i,n))),!0):!1}get(r){if(ut(r))return super.get(r);const[n,o]=v(this,It).call(this,r);return super.get(n)}has(r){if(ut(r))return super.has(r);const[n,o]=v(this,It).call(this,r);return super.has(n)}set(r,n){if(ut(r))return super.set(r,n);const[o,i]=v(this,It).call(this,r);if(super.has(o))super.set(o,n);else{super.set(r,n);const s=v(this,nt).get(i)||[];s.push(r),v(this,nt).set(i,s)}return this}get size(){return super.size}};ke=new WeakMap,nt=new WeakMap,It=new WeakMap;let Ke=mn;function M(t,e){if(!t)throw new ze(e)}const Ea=Object.keys(_o).reduce((t,e)=>(t["[object "+e[0].toUpperCase()+e.substring(1)+"]"]=e,t),{});function ue(t){var r,n;const e=Object.prototype.toString.call(t);return e==="[object Object]"?((n=(r=t==null?void 0:t.constructor)==null?void 0:r.name)==null?void 0:n.toLowerCase())||"object":Ea[e]||e.substring(8,e.length-1).toLowerCase()}const Bt=t=>typeof t=="boolean",Y=t=>typeof t=="string",Da=t=>typeof t=="symbol",F=t=>!isNaN(t)&&typeof t=="number",O=Array.isArray;function q(t){if(!t)return!1;const e=Object.getPrototypeOf(t);return(e===Object.prototype||e===null)&&ue(t)==="object"}const ko=t=>!ut(t),le=t=>t instanceof Date,kt=t=>t instanceof RegExp,Mr=t=>typeof t=="function",Q=t=>t==null,Ia=(t,e=!0)=>!!t||e&&t==="",$r=t=>Q(t)||Y(t)&&!t||O(t)&&t.length===0||q(t)&&Object.keys(t).length===0,he=t=>O(t)?t:[t],Lt=(t,e)=>!!t&&Object.prototype.hasOwnProperty.call(t,e),Pa=t=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(t),fe=(t,e)=>{if(Q(t)||Bt(t)||F(t)||Y(t))return t;if(le(t))return new Date(t);if(kt(t))return new RegExp(t);if(Pa(t)){const r=t.constructor;return new r(t)}if(e instanceof Set||(e=new Set),e.has(t))throw bo;e.add(t);try{if(O(t)){const r=new Array(t.length);for(let n=0;n<t.length;n++)r[n]=fe(t[n],e);return r}if(q(t)){const r={};for(const n of Object.keys(t))r[n]=fe(t[n],e);return r}}finally{e.delete(t)}return t},xo=t=>t===ce;function Ar(t,e){if(xo(t)||Q(t))return e;if(xo(e)||Q(e))return t;if(ut(t)||ut(e))return e;O(t)&&O(e)&&M(t.length===e.length,"arrays must be of equal length to merge.");for(const r of Object.keys(e))t[r]=Ar(t[r],e[r]);return t}function Sa(t,e=He){const r=[Ke.init(e),Ke.init(e)];if(t.length===0)return[];if(t.some(n=>n.length===0))return[];if(t.length===1)return[...t];t[t.length-1].forEach(n=>r[0].set(n,!0));for(let n=t.length-2;n>-1;n--){if(t[n].forEach(o=>{r[0].has(o)&&r[1].set(o,!0)}),r[1].size===0)return[];r.reverse(),r[1].clear()}return Array.from(r[0].keys())}function Oo(t,e=1){const r=new Array;function n(o,i){for(let s=0,a=o.length;s<a;s++)O(o[s])&&(i>0||i<0)?n(o[s],Math.max(-1,i-1)):r.push(o[s])}return n(t,e),r}function Ca(t){const e={};for(;t;){for(const r of Object.getOwnPropertyNames(t))r in e||(e[r]=t[r]);t=Object.getPrototypeOf(t)}return e}function Eo(t){for(;t;){if(Object.getOwnPropertyNames(t).includes("toString"))return t.toString!==Object.prototype.toString;t=Object.getPrototypeOf(t)}return!1}function ht(t,e){if(t===e||Object.is(t,e))return!0;if(t===null||e===null||typeof t!=typeof e||typeof t!="object"||t.constructor!==e.constructor)return!1;if(t instanceof Date)return+t==+e;if(t instanceof RegExp)return t.toString()===e.toString();const r=t.constructor;if(r===Array||r===Object){const n=Object.keys(t).sort(),o=Object.keys(e).sort();if(n.length!==o.length)return!1;for(let i=0,s=n[i];i<n.length;s=n[++i])if(s!==o[i]||!ht(t[s],e[s]))return!1;return!0}return Eo(t)&&t.toString()===e.toString()}const Ue=(t,e)=>{if(t===null)return"null";if(t===void 0)return"undefined";if(Y(t)||F(t)||Bt(t))return JSON.stringify(t);if(le(t))return t.toISOString();if(kt(t)||Da(t)||Mr(t))return t.toString();if(e instanceof Set||(e=new Set),e.has(t))throw bo;try{if(e.add(t),O(t))return"["+t.map(n=>Ue(n,e)).join(",")+"]";if(q(t))return"{"+Object.keys(t).sort().map(n=>`${n}:${Ue(t[n],e)}`).join()+"}";const r=Eo(t)?t.toString():Ue(Ca(t),e);return ue(t)+"("+r+")"}finally{e.delete(t)}};function ja(t,e){return Q(t)?null:(e=e||He,e(t))}function Ra(t,e,r=He){if(t.length<1)return new Map;const n=new Map,o=new Map;for(let i=0;i<t.length;i++){const s=t[i],a=e(s,i),c=ja(a,r);if(c===null)o.has(null)?o.get(null).push(s):o.set(null,[s]);else{const l=n.has(c)?n.get(c).find(u=>ht(u,a)):null;Q(l)?(o.set(a,[s]),n.has(c)?n.get(c).push(a):n.set(c,[a])):o.get(l).push(s)}}return o}function qr(t,e){return ko(t)?t[e]:void 0}function Ma(t,e){if(e<1)return t;for(;e--&&t.length===1;)t=t[0];return t}function xt(t,e,r){let n=0;function o(s,a){let c=s;for(let l=0;l<a.length;l++){const u=a[l];if(/^\d+$/.exec(u)===null&&O(c)){if(l===0&&n>0)break;n+=1;const h=a.slice(l);c=c.reduce((f,d)=>{const p=o(d,h);return p!==void 0&&f.push(p),f},[]);break}else c=qr(c,u);if(c===void 0)break}return c}const i=wo(t)?t:o(t,e.split("."));return O(i)&&(r!=null&&r.unwrapArray)?Ma(i,n):i}function de(t,e,r){const n=e.indexOf("."),o=n==-1?e:e.substring(0,n),i=e.substring(n+1),s=n!=-1;if(O(t)){const l=/^\d+$/.test(o),u=l&&(r!=null&&r.preserveIndex)?[...t]:[];if(l){const h=parseInt(o);let f=qr(t,h);s&&(f=de(f,i,r)),r!=null&&r.preserveIndex?u[h]=f:u.push(f)}else for(const h of t){const f=de(h,e,r);r!=null&&r.preserveMissing?u.push(f??ce):(f!=null||r!=null&&r.preserveIndex)&&u.push(f)}return u}const a=r!=null&&r.preserveKeys?{...t}:{};let c=qr(t,o);if(s&&(c=de(c,i,r)),c!==void 0)return a[o]=c,a}function Nr(t){if(O(t))for(let e=t.length-1;e>=0;e--)t[e]===ce?t.splice(e,1):Nr(t[e]);else if(q(t))for(const e in t)Lt(t,e)&&Nr(t[e])}const Do=/^\d+$/;function Ve(t,e,r,n){const o=e.split("."),i=o[0],s=o.slice(1).join(".");if(o.length===1)(q(t)||O(t)&&Do.test(i))&&r(t,i);else{n!=null&&n.buildGraph&&Q(t[i])&&(t[i]={});const a=t[i];if(!a)return;const c=!!(o.length>1&&Do.test(o[1]));O(a)&&(n!=null&&n.descendArray)&&!c?a.forEach(l=>Ve(l,s,r,n)):Ve(a,s,r,n)}}function $a(t,e,r){Ve(t,e,(n,o)=>{n[o]=Mr(r)?r(n[o]):r},{buildGraph:!0})}function Io(t,e,r){Ve(t,e,(n,o)=>{if(O(n)){if(/^\d+$/.test(o))n.splice(parseInt(o),1);else if(r&&r.descendArray)for(const i of n)q(i)&&delete i[o]}else q(n)&&delete n[o]},r)}const Aa=/^\$[a-zA-Z0-9_]+$/;function Ot(t){return Aa.test(t)}function Po(t){if(wo(t))return kt(t)?{$regex:t}:{$eq:t};if(ko(t)){if(!Object.keys(t).some(Ot))return{$eq:t};if(Lt(t,"$regex")){const e={...t};return e.$regex=new RegExp(t.$regex,t.$options),delete e.$options,e}}return t}var Tr=(t=>(t[t.CLONE_OFF=0]="CLONE_OFF",t[t.CLONE_INPUT=1]="CLONE_INPUT",t[t.CLONE_OUTPUT=2]="CLONE_OUTPUT",t[t.CLONE_ALL=3]="CLONE_ALL",t))(Tr||{});const _e=class _e{constructor(e,r,n){S(this,$);S(this,xe);S(this,ot);C(this,$,e),this.update(r,n)}static init(e,r,n){var o;return e instanceof _e?new _e(v(e,$),e.root??r,{...v(e,ot),...n,variables:Object.assign({},(o=v(e,ot))==null?void 0:o.variables,n==null?void 0:n.variables)}):new _e(e,r,n)}update(e,r){var o;C(this,xe,e);const n=Object.assign({},(o=v(this,ot))==null?void 0:o.variables,r==null?void 0:r.variables);return Object.keys(n).length?C(this,ot,{...r,variables:n}):C(this,ot,r??{}),this}getOptions(){return Object.freeze({...v(this,$),context:Ft.from(v(this,$).context)})}get root(){return v(this,xe)}get local(){return v(this,ot)}get idKey(){return v(this,$).idKey}get collation(){var e;return(e=v(this,$))==null?void 0:e.collation}get processingMode(){var e;return((e=v(this,$))==null?void 0:e.processingMode)||0}get useStrictMode(){var e;return(e=v(this,$))==null?void 0:e.useStrictMode}get scriptEnabled(){var e;return(e=v(this,$))==null?void 0:e.scriptEnabled}get useGlobalContext(){var e;return(e=v(this,$))==null?void 0:e.useGlobalContext}get hashFunction(){var e;return(e=v(this,$))==null?void 0:e.hashFunction}get collectionResolver(){var e;return(e=v(this,$))==null?void 0:e.collectionResolver}get jsonSchemaValidator(){var e;return(e=v(this,$))==null?void 0:e.jsonSchemaValidator}get variables(){var e;return(e=v(this,$))==null?void 0:e.variables}get context(){var e;return(e=v(this,$))==null?void 0:e.context}};$=new WeakMap,xe=new WeakMap,ot=new WeakMap;let pe=_e;function qa(t){return t instanceof pe?t.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:0,...t,context:t!=null&&t.context?Ft.from(t==null?void 0:t.context):Ft.init()})}const ir=class ir{constructor(){S(this,ft,new Map)}static init(){return new ir}static from(e){const r=ir.init();return Q(e)||v(e,ft).forEach((n,o)=>r.addOperators(o,n)),r}addOperators(e,r){v(this,ft).has(e)||v(this,ft).set(e,{});for(const[n,o]of Object.entries(r))this.getOperator(e,n)||(v(this,ft).get(e)[n]=o);return this}getOperator(e,r){return(v(this,ft).get(e)??{})[r]??null}addAccumulatorOps(e){return this.addOperators("accumulator",e)}addExpressionOps(e){return this.addOperators("expression",e)}addQueryOps(e){return this.addOperators("query",e)}addPipelineOps(e){return this.addOperators("pipeline",e)}addProjectionOps(e){return this.addOperators("projection",e)}addWindowOps(e){return this.addOperators("window",e)}};ft=new WeakMap;let Ft=ir;const Et=Ft.init();function So(t,e){for(const[r,n]of Object.entries(e)){M(Mr(n)&&Ot(r),`'${r}' is not a valid operator`);const o=me(t,r,null);M(!o||n===o,`${r} already exists for '${t}' operators. Cannot change operator function once registered.`)}switch(t){case"accumulator":Et.addAccumulatorOps(e);break;case"expression":Et.addExpressionOps(e);break;case"pipeline":Et.addPipelineOps(e);break;case"projection":Et.addProjectionOps(e);break;case"query":Et.addQueryOps(e);break;case"window":Et.addWindowOps(e);break}}function me(t,e,r){const{context:n,useGlobalContext:o}=r||{},i=n?n.getOperator(t,e):null;return!i&&o?Et.getOperator(t,e):i}function Qt(t,e,r,n){const o=pe.init(n,t);return r&&Ot(r)?Co(t,e,r,o):Je(t,e,o)}const Na=["$$ROOT","$$CURRENT","$$REMOVE","$$NOW"];function Je(t,e,r){var n;if(Y(e)&&e.length>0&&e[0]==="$"){if(Ta.includes(e))return e;let o=r.root;const i=e.split(".");if(Na.includes(i[0])){switch(i[0]){case"$$ROOT":break;case"$$CURRENT":o=t;break;case"$$REMOVE":o=void 0;break;case"$$NOW":o=new Date;break}e=e.slice(i[0].length+1)}else if(i[0].slice(0,2)==="$$"){o=Object.assign({},r.variables,{this:t},(n=r==null?void 0:r.local)==null?void 0:n.variables);const s=i[0].slice(2);M(Lt(o,s),`Use of undefined variable: ${s}`),e=e.slice(2)}else e=e.slice(1);return e===""?o:xt(o,e)}if(O(e))return e.map(o=>Je(t,o,r));if(q(e)){const o={},i=Object.entries(e);for(const[s,a]of i){if(Ot(s))return M(i.length==1,"expression must have single operator."),Co(t,a,s,r);o[s]=Je(t,a,r)}return o}return e}function Co(t,e,r,n){const o=me("expression",r,n);if(o)return o(t,e,n);const i=me("accumulator",r,n);return M(!!i,`accumulator '${r}' is not registered.`),O(t)||(t=Je(t,e,n),e=null),M(O(t),`arguments must resolve to array for ${r}.`),i(t,e,n)}const Ta=["$$KEEP","$$PRUNE","$$DESCEND"];function ve(t){return t instanceof jo?t:new jo(t)}function Ba(...t){let e=0;return ve(()=>{for(;e<t.length;){const r=t[e].next();if(!r.done)return r;e++}return{done:!0}})}function La(t){return!!t&&typeof t=="object"&&(t==null?void 0:t.next)instanceof Function}function Fa(t,e){const r=t.slice(e+1);t.splice(e),Array.prototype.push.apply(t,r)}const Br=new Error;function Qa(t,e,r){let n=!1,o=-1,i=0;return function(s){try{t:for(;!n;){let a=t();o++;let c=-1;const l=e.length;let u=!1;for(;++c<l;){const h=e[c];switch(h.action){case 0:a=h.func(a,o);break;case 1:if(!h.func(a,o))continue t;break;case 2:--h.count,h.count||(u=!0);break;case 3:--h.count,h.count||Fa(e,c);continue t;default:break t}}if(n=u,s)r[i++]=a;else return{value:a,done:!1}}}catch(a){if(a!==Br)throw a}return n=!0,{done:n}}}class jo{constructor(e){S(this,Pt);S(this,Kt);S(this,Ut);C(this,Pt,[]),C(this,Kt,[]),this.isDone=!1;let r;if(e instanceof Function&&(e={next:e}),La(e)){const n=e;r=()=>{const o=n.next();if(o.done)throw Br;return o.value}}else if(O(e)){const n=e,o=n.length;let i=0;r=()=>{if(i<o)return n[i++];throw Br}}else if(!(e instanceof Function))throw new ze("Lazy must be initialized with an array, generator, or function.");C(this,Ut,Qa(r,v(this,Pt),v(this,Kt)))}push(e,r){return typeof r=="function"?v(this,Pt).push({action:e,func:r}):typeof r=="number"&&v(this,Pt).push({action:e,count:r}),this}next(){return v(this,Ut).call(this)}map(e){return this.push(0,e)}filter(e){return this.push(1,e)}take(e){return e>0?this.push(2,e):this}drop(e){return e>0?this.push(3,e):this}transform(e){const r=this;let n;return ve(()=>(n||(n=ve(e(r.value()))),n.next()))}value(){return this.isDone||(this.isDone=v(this,Ut).call(this,!0).done),v(this,Kt)}each(e){for(;;){const r=this.next();if(r.done)break;if(e(r.value)===!1)return!1}return!0}reduce(e,r){let n=this.next();for(r===void 0&&!n.done&&(r=n.value,n=this.next());!n.done;)r=e(r,n.value),n=this.next();return r}size(){return this.reduce((e,r)=>++e,0)}[Symbol.iterator](){return this}}Pt=new WeakMap,Kt=new WeakMap,Ut=new WeakMap;const Wa=(t,e,r)=>t.take(e),Ro=(t,e,r)=>$r(e)?t:($o(e,r),t.map(Mo(e,pe.init(r))));function Mo(t,e,r=!0){const n=e.idKey,o=Object.keys(t),i=new Array,s=new Array,a={};for(const f of o){const d=t[f];if(F(d)||Bt(d))d?s.push(f):i.push(f);else if(O(d))a[f]=p=>d.map(m=>Qt(p,m,null,e.update(p))??null);else if(q(d)){const p=Object.keys(d),m=p.length==1?p[0]:"",y=me("projection",m,e);y?m==="$slice"&&!he(d[m]).every(F)?a[f]=g=>Qt(g,d,f,e.update(g)):a[f]=g=>y(g,d[m],f,e.update(g)):Ot(m)?a[f]=g=>Qt(g,d[m],m,e):($o(d,e),a[f]=g=>{if(!Lt(g,f))return Qt(g,d,null,e);r&&e.update(g);const w=xt(g,f),_=Mo(d,e,!1);return O(w)?w.map(_):q(w)?_(w):_(g)})}else a[f]=Y(d)&&d[0]==="$"?p=>Qt(p,d,f,e):p=>d}const c=Object.keys(a),l=i.includes(n);if(r&&l&&i.length===1&&!s.length&&!c.length)return f=>{const d={...f};return delete d[n],d};const u=r&&!l&&!s.includes(n),h={preserveMissing:!0};return f=>{const d={};if(i.length&&!s.length){Ar(d,f);for(const p of i)Io(d,p,{descendArray:!0})}for(const p of s){const m=de(f,p,h)??{};Ar(d,m)}s.length&&Nr(d);for(const p of c){const m=a[p](f);m===void 0?Io(d,p,{descendArray:!0}):$a(d,p,m)}return u&&Lt(f,n)&&(d[n]=xt(f,n)),d}}function $o(t,e){let r=!1,n=!1;for(const[o,i]of Object.entries(t))M(!o.startsWith("$"),"Field names may not start with '$'."),M(!o.endsWith(".$"),"Positional projection operator '$' is not supported."),o!==(e==null?void 0:e.idKey)&&(i===0||i===!1?r=!0:(i===1||i===!0)&&(n=!0),M(!(r&&n),"Projection cannot have a mix of inclusion and exclusion."))}const za=(t,e,r)=>t.drop(e),Ao=(t,e,r)=>{if($r(e)||!q(e))return t;let n=lt;const o=r.collation;return q(o)&&Y(o.locale)&&(n=Ka(o)),t.transform(i=>{const s=Object.keys(e);for(const a of s.reverse()){const c=Ra(i,h=>xt(h,a),r.hashFunction),l=Array.from(c.keys()).sort(n);e[a]===-1&&l.reverse();let u=0;for(const h of l)for(const f of c.get(h))i[u++]=f;M(u==i.length,"bug: counter must match collection size.")}return i})},Ha={1:"base",2:"accent",3:"variant"};function Ka(t){const e={sensitivity:Ha[t.strength||3],caseFirst:t.caseFirst==="off"?"false":t.caseFirst||"false",numeric:t.numericOrdering||!1,ignorePunctuation:t.alternate==="shifted"};(t.caseLevel||!1)===!0&&(e.sensitivity==="base"&&(e.sensitivity="case"),e.sensitivity==="accent"&&(e.sensitivity="variant"));const r=new Intl.Collator(t.locale,e);return(n,o)=>{if(!Y(n)||!Y(o))return lt(n,o);const i=r.compare(n,o);return i<0?-1:i>0?1:0}}const Ua={$sort:Ao,$skip:za,$limit:Wa};class Va{constructor(e,r,n,o){S(this,Oe);S(this,Ee);S(this,Vt);S(this,it);S(this,dt,{});S(this,H,null);S(this,st,[]);C(this,Oe,e),C(this,Ee,r),C(this,Vt,n),C(this,it,o)}fetch(){if(v(this,H))return v(this,H);C(this,H,ve(v(this,Oe)).filter(v(this,Ee)));const e=v(this,it).processingMode;e&Tr.CLONE_INPUT&&v(this,H).map(fe);for(const r of["$sort","$skip","$limit"])Lt(v(this,dt),r)&&C(this,H,Ua[r](v(this,H),v(this,dt)[r],v(this,it)));return Object.keys(v(this,Vt)).length&&C(this,H,Ro(v(this,H),v(this,Vt),v(this,it))),e&Tr.CLONE_OUTPUT&&v(this,H).map(fe),v(this,H)}fetchAll(){const e=ve([...v(this,st)]);return C(this,st,[]),Ba(e,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(e){return v(this,dt).$skip=e,this}limit(e){return v(this,dt).$limit=e,this}sort(e){return v(this,dt).$sort=e,this}collation(e){return C(this,it,{...v(this,it),collation:e}),this}next(){if(v(this,st).length>0)return v(this,st).pop();const e=this.fetch().next();if(!e.done)return e.value}hasNext(){if(v(this,st).length>0)return!0;const e=this.fetch().next();return e.done?!1:(v(this,st).push(e.value),!0)}map(e){return this.all().map(e)}forEach(e){this.all().forEach(e)}[Symbol.iterator](){return this.fetchAll()}}Oe=new WeakMap,Ee=new WeakMap,Vt=new WeakMap,it=new WeakMap,dt=new WeakMap,H=new WeakMap,st=new WeakMap;const Ja=new Set(Array.from(["$and","$or","$nor","$expr","$jsonSchema"]));class ye{constructor(e,r){S(this,Jt);S(this,pt);S(this,St);C(this,St,fe(e)),C(this,pt,qa(r)),C(this,Jt,[]),this.compile()}compile(){M(q(v(this,St)),`query criteria must be an object: ${JSON.stringify(v(this,St))}`);const e={};for(const[r,n]of Object.entries(v(this,St))){if(r==="$where")M(v(this,pt).scriptEnabled,"$where operator requires 'scriptEnabled' option to be true."),Object.assign(e,{field:r,expr:n});else if(Ja.has(r))this.processOperator(r,r,n);else{M(!Ot(r),`unknown top level operator: ${r}`);for(const[o,i]of Object.entries(Po(n)))this.processOperator(r,o,i)}e.field&&this.processOperator(e.field,e.field,e.expr)}}processOperator(e,r,n){const o=me("query",r,v(this,pt));M(!!o,`unknown query operator ${r}`),v(this,Jt).push(o(e,n,v(this,pt)))}test(e){return v(this,Jt).every(r=>r(e))}find(e,r){return new Va(e,n=>this.test(n),r||{},v(this,pt))}remove(e){return e.reduce((r,n)=>(this.test(n)||r.push(n),r),[])}}Jt=new WeakMap,pt=new WeakMap,St=new WeakMap;const Ga=["monday","mon","tuesday","tue","wednesday","wed","thursday","thu","friday","fri","saturday","sat","sunday","sun"];new Set(Ga);function W(t){return(e,r,n)=>{const o={unwrapArray:!0},i=Math.max(1,e.split(".").length-1);return s=>{const a=xt(s,e,o);return t(a,r,{...n,depth:i})}}}function qo(t,e,r){return ht(t,e)||Q(t)&&Q(e)?!0:O(t)?t.some(n=>ht(n,e))||Oo(t,r==null?void 0:r.depth).some(n=>ht(n,e)):!1}function Ya(t,e,r){return!qo(t,e,r)}function No(t,e,r){return Q(t)?e.some(n=>n===null):Sa([he(t),e],r==null?void 0:r.hashFunction).length>0}function Za(t,e,r){return!No(t,e,r)}function Xa(t,e,r){return Ge(t,e,(n,o)=>lt(n,o)<0)}function tc(t,e,r){return Ge(t,e,(n,o)=>lt(n,o)<=0)}function ec(t,e,r){return Ge(t,e,(n,o)=>lt(n,o)>0)}function rc(t,e,r){return Ge(t,e,(n,o)=>lt(n,o)>=0)}function nc(t,e,r){return he(t).some(n=>e.length===2&&n%e[0]===e[1])}function oc(t,e,r){const n=he(t),o=i=>Y(i)&&Ia(e.exec(i),r==null?void 0:r.useStrictMode);return n.some(o)||Oo(n,1).some(o)}function ic(t,e,r){return Array.isArray(t)&&t.length===e}function sc(t){return Ot(t)&&["$and","$or","$nor"].indexOf(t)===-1}function ac(t,e,r){if(O(t)&&!$r(t)){let n=s=>s,o=e;Object.keys(e).every(sc)&&(o={temp:e},n=s=>({temp:s}));const i=new ye(o,r);for(let s=0,a=t.length;s<a;s++)if(i.test(n(t[s])))return!0}return!1}const To=t=>t===null,cc={array:O,boolean:Bt,bool:Bt,date:le,number:F,int:F,long:F,double:F,decimal:F,null:To,object:q,regexp:kt,regex:kt,string:Y,undefined:Q,function:t=>{throw new ze("unsupported type key `function`.")},1:F,2:Y,3:q,4:O,6:Q,8:Bt,9:le,10:To,11:kt,16:F,18:F,19:F};function Bo(t,e,r){const n=cc[e];return n?n(t):!1}function uc(t,e,r){return O(e)?e.findIndex(n=>Bo(t,n))>=0:Bo(t,e)}function Ge(t,e,r){return he(t).some(n=>ue(n)===ue(e)&&r(n,e))}const Lo=(t,e)=>{const r={};return t.split("").forEach((n,o)=>r[n]=e*(o+1)),r};({...Lo("ABCDEFGHIKLM",1),...Lo("NOPQRSTUVWXY",-1)});const Fo={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error};function z(t,e=Fo){const r=Object.assign({},Fo,e),n=new Set(Object.keys(r));return(o,i,s)=>{const a=Qt(o,i,null,s);if(n.has(`${a}`)){const c=r[`${a}`];if(c instanceof Error)throw new ze(`cannot apply $${t.name} to -inf, value must in (-inf,inf)`);return c}return t(a)}}z(Math.acos,{Infinity:1/0,0:new Error}),z(Math.acosh,{Infinity:1/0,0:new Error}),z(Math.asin),z(Math.asinh,{Infinity:1/0,"-Infinity":-1/0}),z(Math.atan),z(Math.atanh,{1:1/0,"-1":-1/0}),z(Math.cos),z(Math.cosh,{"-Infinity":1/0,Infinity:1/0});const lc=Math.PI/180;z(t=>t*lc,{Infinity:1/0,"-Infinity":1/0});const hc=180/Math.PI;z(t=>t*hc,{Infinity:1/0,"-Infinity":-1/0}),z(Math.sin),z(Math.sinh,{"-Infinity":-1/0,Infinity:1/0}),z(Math.tan);const fc=(t,e,r)=>{M(O(e),"Invalid expression: $and expects value to be an Array.");const n=e.map(o=>new ye(o,r));return o=>n.every(i=>i.test(o))},Qo=(t,e,r)=>{M(O(e),"Invalid expression. $or expects value to be an Array");const n=e.map(o=>new ye(o,r));return o=>n.some(i=>i.test(o))},dc=(t,e,r)=>{M(O(e),"Invalid expression. $nor expects value to be an array.");const n=Qo("$or",e,r);return o=>!n(o)},pc=(t,e,r)=>{const n={};n[t]=Po(e);const o=new ye(n,r);return i=>!o.test(i)},mc=W(qo),vc=W(ec),yc=W(rc),gc=W(No),bc=W(Xa),wc=W(tc),_c=W(Ya),kc=W(Za),xc=W(nc),Oc=W(oc),Ec=W(ac),Dc=W(ic),Ic=(t,e,r)=>{const n=t.includes("."),o=!!e;return!n||t.match(/\.\d+$/)?i=>xt(i,t)!==void 0===o:i=>{const s=de(i,t,{preserveIndex:!0}),a=xt(s,t.substring(0,t.lastIndexOf(".")));return O(a)?a.some(c=>c!==void 0)===o:a!==void 0===o}},Pc=W(uc);var Wo=!1;function Sc(t){return Wo||(So("pipeline",{$sort:Ao,$project:Ro}),So("query",{$and:fc,$eq:mc,$elemMatch:Ec,$exists:Ic,$gt:vc,$gte:yc,$in:gc,$lt:bc,$lte:wc,$ne:_c,$nin:kc,$mod:xc,$nor:dc,$not:pc,$or:Qo,$regex:Oc,$size:Dc,$type:Pc}),Wo=!0),new ye(t)}function Ye(t,e){var r=bt(t.primaryKey);e=T(e);var n=Mt(e);if(typeof n.skip!="number"&&(n.skip=0),n.selector?(n.selector=n.selector,Object.entries(n.selector).forEach(([h,f])=>{(typeof f!="object"||f===null)&&(n.selector[h]={$eq:f})})):n.selector={},n.index){var o=bn(n.index);o.includes(r)||o.push(r),n.index=o}if(n.sort){var i=n.sort.find(h=>ns(h)===r);i||(n.sort=n.sort.slice(0),n.sort.push({[r]:"asc"}))}else if(n.index)n.sort=n.index.map(h=>({[h]:"asc"}));else{if(t.indexes){var s=new Set;Object.entries(n.selector).forEach(([h,f])=>{var d=!1;typeof f=="object"&&f!==null?d=!!Object.keys(f).find(p=>Rr.has(p)):d=!0,d&&s.add(h)});var a=-1,c;t.indexes.forEach(h=>{var f=Zt(h)?h:[h],d=f.findIndex(p=>!s.has(p));d>0&&d>a&&(a=d,c=f)}),c&&(n.sort=c.map(h=>({[h]:"asc"})))}if(!n.sort)if(t.indexes&&t.indexes.length>0){var l=t.indexes[0],u=Zt(l)?l:[l];n.sort=u.map(h=>({[h]:"asc"}))}else n.sort=[{[r]:"asc"}]}return n}function zo(t,e){if(!e.sort)throw b("SNH",{query:e});var r=[];e.sort.forEach(o=>{var i=Object.keys(o)[0],s=Object.values(o)[0];r.push({key:i,direction:s,getValueFn:rs(i)})});var n=(o,i)=>{for(var s=0;s<r.length;++s){var a=r[s],c=a.getValueFn(o),l=a.getValueFn(i);if(c!==l){var u=a.direction==="asc"?lt(c,l):lt(l,c);return u}}};return n}function Lr(t,e){if(!e.sort)throw b("SNH",{query:e});var r=Sc(e.selector),n=o=>r.test(o);return n}async function ge(t,e){var r=await t.exec();if(!r)return null;if(Array.isArray(r))return Promise.all(r.map(o=>e(o)));if(r instanceof Map)return Promise.all([...r.values()].map(o=>e(o)));var n=await e(r);return n}function Fr(t,e){if(!e.sort)throw b("SNH",{query:e});var r=ba(t,e);return{query:e,queryPlan:r}}var Cc="_rxdb_internal";async function jc(t,e){var r=await t.findDocumentsById([e],!1),n=r[0];if(n)return n}function Ze(t,e,r,n){if(n)throw n.status===409?b("CONFLICT",{collection:t.name,id:e,writeError:n,data:r}):n.status===422?b("VD2",{collection:t.name,id:e,writeError:n,data:r}):n}function Rc(t,e,r,n,o,i,s){for(var a=!!t.schema.attachments,c=[],l=[],u=[],h=Te(10),f={id:h,events:[],checkpoint:null,context:o},d=f.events,p=[],m=[],y=[],g=r.size>0,w,_=n.length,A=function(){var k=n[x],D=k.document,I=k.previous,N=D[e],mt=D._deleted,sr=I&&I._deleted,Gt=void 0;g&&(Gt=r.get(N));var vt;if(Gt){var Fi=Gt._rev;if(!I||I&&Fi!==I._rev){var Qi={isError:!0,status:409,documentId:N,writeRow:k,documentInDb:Gt};return u.push(Qi),1}var De=a?Qr(k):k;a&&(mt?I&&Object.keys(I._attachments).forEach(L=>{m.push({documentId:N,attachmentId:L,digest:P(I)._attachments[L].digest})}):(Object.entries(D._attachments).find(([L,J])=>{var Se=I?I._attachments[L]:void 0;return!Se&&!J.data&&(vt={documentId:N,documentInDb:Gt,isError:!0,status:510,writeRow:k,attachmentId:L}),!0}),vt||Object.entries(D._attachments).forEach(([L,J])=>{var Se=I?I._attachments[L]:void 0;if(!Se)p.push({documentId:N,attachmentId:L,attachmentData:J,digest:J.digest});else{var Ki=De.document._attachments[L].digest;J.data&&Se.digest!==Ki&&y.push({documentId:N,attachmentId:L,attachmentData:J,digest:J.digest})}}))),vt?u.push(vt):(a?l.push(Qr(De)):l.push(De),w=De);var Ie=null,ar=null,Pe=null;if(sr&&!mt)Pe="INSERT",Ie=a?et(D):D;else if(I&&!sr&&!mt)Pe="UPDATE",Ie=a?et(D):D,ar=I;else if(mt)Pe="DELETE",Ie=P(D),ar=I;else throw b("SNH",{args:{writeRow:k}});var Wi={documentId:N,documentData:Ie,previousDocumentData:ar,operation:Pe};d.push(Wi)}else{var zi=!!mt;if(a&&Object.entries(D._attachments).forEach(([L,J])=>{J.data?p.push({documentId:N,attachmentId:L,attachmentData:J,digest:J.digest}):(vt={documentId:N,isError:!0,status:510,writeRow:k,attachmentId:L},u.push(vt))}),vt||(a?c.push(Qr(k)):c.push(k),w=k),!zi){var Hi={documentId:N,operation:"INSERT",documentData:a?et(D):D,previousDocumentData:a&&I?et(I):I};d.push(Hi)}}},x=0;x<_;x++)A();return{bulkInsertDocs:c,bulkUpdateDocs:l,newestRow:w,errors:u,eventBulk:f,attachmentsAdd:p,attachmentsRemove:m,attachmentsUpdate:y}}function Qr(t){return{previous:t.previous,document:et(t.document)}}function Mc(t){return atob(t).length}function $c(t){var e=t.data;if(!e)return t;var r={length:Mc(e),digest:t.digest,type:t.type};return r}function et(t){if(!t._attachments||Object.keys(t._attachments).length===0)return t;var e=T(t);return e._attachments={},Object.entries(t._attachments).forEach(([r,n])=>{e._attachments[r]=$c(n)}),e}function Xe(t){return Object.assign({},t,{_meta:T(t._meta)})}function Ho(t,e,r){j.deepFreezeWhenDevMode(r);var n=bt(e.schema.primaryKey),o={originalStorageInstance:e,schema:e.schema,internals:e.internals,collectionName:e.collectionName,databaseName:e.databaseName,options:e.options,async bulkWrite(i,s){for(var a=t.token,c=new Array(i.length),l=gt(),u=0;u<i.length;u++){var h=i[u],f=Xe(h.document);f._meta.lwt=l;var d=h.previous;f._rev=lr(a,d),c[u]={document:f,previous:d}}B("preStorageWrite",{storageInstance:this.originalStorageInstance,rows:c});var p=await t.lockedRun(()=>e.bulkWrite(c,s)),m={error:[]};Ko.set(m,c);var y=p.error.length===0?[]:p.error.filter(k=>k.status===409&&!k.writeRow.previous&&!k.writeRow.document._deleted&&P(k.documentInDb)._deleted?!0:(m.error.push(k),!1));if(y.length>0){var g=new Set,w=y.map(k=>(g.add(k.documentId),{previous:k.documentInDb,document:Object.assign({},k.writeRow.document,{_rev:lr(t.token,k.documentInDb)})})),_=await t.lockedRun(()=>e.bulkWrite(w,s));Rt(m.error,_.error);var A=Dt(n,c,m,g),x=Dt(n,w,_);return Rt(A,x),m}return m},query(i){return t.lockedRun(()=>e.query(i))},count(i){return t.lockedRun(()=>e.count(i))},findDocumentsById(i,s){return t.lockedRun(()=>e.findDocumentsById(i,s))},getAttachmentData(i,s,a){return t.lockedRun(()=>e.getAttachmentData(i,s,a))},getChangedDocumentsSince:e.getChangedDocumentsSince?(i,s)=>t.lockedRun(()=>e.getChangedDocumentsSince(P(i),s)):void 0,cleanup(i){return t.lockedRun(()=>e.cleanup(i))},remove(){return t.storageInstances.delete(o),t.lockedRun(()=>e.remove())},close(){return t.storageInstances.delete(o),t.lockedRun(()=>e.close())},changeStream(){return e.changeStream()}};return t.storageInstances.add(o),o}function Ac(t){if(t.schema.keyCompression)throw b("UT5",{args:{params:t}});if(qc(t.schema))throw b("UT6",{args:{params:t}});if(t.schema.attachments&&t.schema.attachments.compression)throw b("UT7",{args:{params:t}})}function qc(t){return!!(t.encrypted&&t.encrypted.length>0||t.attachments&&t.attachments.encrypted)}var Ko=new WeakMap,Nc=new WeakMap;function Dt(t,e,r,n){return G(Nc,r,()=>{var o=[],i=Ko.get(r);if(i||(i=e),r.error.length>0||n){for(var s=n||new Set,a=0;a<r.error.length;a++){var c=r.error[a];s.add(c.documentId)}for(var l=0;l<i.length;l++){var u=i[l].document;s.has(u[t])||o.push(et(u))}}else{o.length=e.length-r.error.length;for(var h=0;h<i.length;h++){var f=i[h].document;o[h]=et(f)}}return o})}var Tc=(function(){function t(r,n,o,i){this.queueByDocId=new Map,this.isRunning=!1,this.storageInstance=r,this.primaryPath=n,this.preWrite=o,this.postWrite=i}var e=t.prototype;return e.addWrite=function(r,n){var o=r[this.primaryPath],i=G(this.queueByDocId,o,()=>[]),s=new Promise((a,c)=>{var l={lastKnownDocumentState:r,modifier:n,resolve:a,reject:c};P(i).push(l),this.triggerRun()});return s},e.triggerRun=async function(){if(!(this.isRunning===!0||this.queueByDocId.size===0)){this.isRunning=!0;var r=[],n=this.queueByDocId;this.queueByDocId=new Map,await Promise.all(Array.from(n.entries()).map(async([i,s])=>{var a=Bc(s.map(u=>u.lastKnownDocumentState)),c=a;for(var l of s)try{c=await l.modifier(Mt(c))}catch(u){l.reject(u),l.reject=()=>{},l.resolve=()=>{}}try{await this.preWrite(c,a)}catch(u){s.forEach(h=>h.reject(u));return}r.push({previous:a,document:c})}));var o=r.length>0?await this.storageInstance.bulkWrite(r,"incremental-write"):{error:[]};return await Promise.all(Dt(this.primaryPath,r,o).map(i=>{var s=i[this.primaryPath];this.postWrite(i);var a=Be(n,s);a.forEach(c=>c.resolve(i))})),o.error.forEach(i=>{var s=i.documentId,a=Be(n,s),c=Pn(i);if(c){var l=G(this.queueByDocId,s,()=>[]);a.reverse().forEach(h=>{h.lastKnownDocumentState=P(c.documentInDb),P(l).unshift(h)})}else{var u=Sn(i);a.forEach(h=>h.reject(u))}}),this.isRunning=!1,this.triggerRun()}},t})();function Uo(t){var e=async r=>{var n=os(r);n._deleted=r._deleted;var o=await t(n),i=Object.assign({},o,{_meta:r._meta,_attachments:r._attachments,_rev:r._rev,_deleted:typeof o._deleted<"u"?o._deleted:r._deleted});return typeof i._deleted>"u"&&(i._deleted=!1),i};return e}function Bc(t){var e=t[0],r=Xt(e._rev);return t.forEach(n=>{var o=Xt(n._rev);o>r&&(e=n,r=o)}),e}var tr={get primaryPath(){var t=this;if(t.isInstanceOfRxDocument)return t.collection.schema.primaryPath},get primary(){var t=this;if(t.isInstanceOfRxDocument)return t._data[t.primaryPath]},get revision(){var t=this;if(t.isInstanceOfRxDocument)return t._data._rev},get deleted$(){var t=this;if(t.isInstanceOfRxDocument)return t.$.pipe(Z(e=>e._data._deleted))},get deleted$$(){var t=this,e=t.collection.database.getReactivityFactory();return e.fromObservable(t.deleted$,t.getLatest().deleted,t.collection.database)},get deleted(){var t=this;if(t.isInstanceOfRxDocument)return t._data._deleted},getLatest(){var t=this.collection._docCache.getLatestDocumentData(this.primary);return this.collection._docCache.getCachedRxDocument(t)},get $(){var t=this,e=this.primary;return t.collection.eventBulks$.pipe(U(r=>!r.isLocal),Z(r=>r.events.find(n=>n.documentId===e)),U(r=>!!r),Z(r=>ma(P(r))),yo(t.collection._docCache.getLatestDocumentData(e)),Cr((r,n)=>r._rev===n._rev),Z(r=>this.collection._docCache.getCachedRxDocument(r)),vo(An))},get $$(){var t=this,e=t.collection.database.getReactivityFactory();return e.fromObservable(t.$,t.getLatest()._data,t.collection.database)},get$(t){if(j.isDevMode()){if(t.includes(".item."))throw b("DOC1",{path:t});if(t===this.primaryPath)throw b("DOC2");if(this.collection.schema.finalFields.includes(t))throw b("DOC3",{path:t});var e=ie(this.collection.schema.jsonSchema,t);if(!e)throw b("DOC4",{path:t})}return this.$.pipe(Z(r=>re(r,t)),Cr())},get$$(t){var e=this.get$(t),r=this.collection.database.getReactivityFactory();return r.fromObservable(e,this.getLatest().get(t),this.collection.database)},populate(t){var e=ie(this.collection.schema.jsonSchema,t),r=this.get(t);if(!r)return ys;if(!e)throw b("DOC5",{path:t});if(!e.ref)throw b("DOC6",{path:t,schemaObj:e});var n=this.collection.database.collections[e.ref];if(!n)throw b("DOC7",{ref:e.ref,path:t,schemaObj:e});return e.type==="array"?n.findByIds(r).exec().then(o=>{var i=o.values();return Array.from(i)}):n.findOne(r).exec()},get(t){return Go(this,t)},toJSON(t=!1){if(t)return j.deepFreezeWhenDevMode(this._data);var e=T(this._data);return delete e._rev,delete e._attachments,delete e._deleted,delete e._meta,j.deepFreezeWhenDevMode(e)},toMutableJSON(t=!1){return Mt(this.toJSON(t))},update(t){throw E("update")},incrementalUpdate(t){throw E("update")},updateCRDT(t){throw E("crdt")},putAttachment(){throw E("attachments")},putAttachmentBase64(){throw E("attachments")},getAttachment(){throw E("attachments")},allAttachments(){throw E("attachments")},get allAttachments$(){throw E("attachments")},async modify(t,e){var r=this._data,n=await Uo(t)(r);return this._saveData(n,r)},incrementalModify(t,e){return this.collection.incrementalWriteQueue.addWrite(this._data,Uo(t)).then(r=>this.collection._docCache.getCachedRxDocument(r))},patch(t){var e=this._data,r=Mt(e);return Object.entries(t).forEach(([n,o])=>{r[n]=o}),this._saveData(r,e)},incrementalPatch(t){return this.incrementalModify(e=>(Object.entries(t).forEach(([r,n])=>{e[r]=n}),e))},async _saveData(t,e){if(t=T(t),this._data._deleted)throw b("DOC11",{id:this.primary,document:this});await Jo(this.collection,t,e);var r=[{previous:e,document:t}],n=await this.collection.storageInstance.bulkWrite(r,"rx-document-save-data"),o=n.error[0];return Ze(this.collection,this.primary,t,o),await this.collection._runHooks("post","save",t,this),this.collection._docCache.getCachedRxDocument(Dt(this.collection.schema.primaryPath,r,n)[0])},async remove(){if(this.deleted)return Promise.reject(b("DOC13",{document:this,id:this.primary}));var t=await this.collection.bulkRemove([this]);if(t.error.length>0){var e=t.error[0];Ze(this.collection,this.primary,this._data,e)}return t.success[0]},incrementalRemove(){return this.incrementalModify(async t=>(await this.collection._runHooks("pre","remove",t,this),t._deleted=!0,t)).then(async t=>(await this.collection._runHooks("post","remove",t._data,t),t))},close(){throw b("DOC14")}};function Vo(t=tr){var e=function(r,n){this.collection=r,this._data=n,this._propertyCache=new Map,this.isInstanceOfRxDocument=!0};return e.prototype=t,e}function Lc(t,e,r){var n=new t(e,r);return B("createRxDocument",n),n}function Jo(t,e,r){return e._meta=Object.assign({},r._meta,e._meta),j.isDevMode()&&t.schema.validateChange(r,e),t._runHooks("pre","save",e,r)}function Go(t,e){return G(t._propertyCache,e,()=>{var r=re(t._data,e);if(typeof r!="object"||r===null||Array.isArray(r))return j.deepFreezeWhenDevMode(r);var n=new Proxy(T(r),{get(o,i){if(typeof i!="string")return o[i];var s=i.charAt(i.length-1);if(s==="$")if(i.endsWith("$$")){var a=i.slice(0,-2);return t.get$$(At(e+"."+a))}else{var c=i.slice(0,-1);return t.get$(At(e+"."+c))}else if(s==="_"){var l=i.slice(0,-1);return t.populate(At(e+"."+l))}else{var u=o[i];return typeof u=="number"||typeof u=="string"||typeof u=="boolean"?u:Go(t,At(e+"."+i))}}});return n})}function Wr(t){return t[t.length-1]}function Fc(t){const e=typeof t;return t!==null&&(e==="object"||e==="function")}function Yo(t,e,r){if(Array.isArray(e)&&(e=e.join(".")),!Fc(t)||typeof e!="string")return t;const n=e.split(".");if(n.length===0)return r;for(let o=0;o<n.length;o++){const i=n[o];if(Qc(t,i)?t=o===n.length-1?void 0:null:t=t[i],t==null){if(o!==n.length-1)return r;break}}return t===void 0?r:t}function Qc(t,e){if(typeof e!="number"&&Array.isArray(t)){const r=Number.parseInt(e,10);return Number.isInteger(r)&&t[r]===t[e]}return!1}const Zo=t=>!!t.queryParams.limit,Wc=t=>t.queryParams.limit===1,zc=t=>!!(t.queryParams.skip&&t.queryParams.skip>0),Hc=t=>t.changeEvent.operation==="DELETE",Kc=t=>t.changeEvent.operation==="INSERT",Uc=t=>t.changeEvent.operation==="UPDATE",Vc=t=>Zo(t)&&t.previousResults.length>=t.queryParams.limit,Jc=t=>{const e=t.queryParams.sortFields,r=t.changeEvent.previous,n=t.changeEvent.doc;if(!n)return!1;if(!r)return!0;for(let o=0;o<e.length;o++){const i=e[o],s=Yo(r,i),a=Yo(n,i);if(s!==a)return!0}return!1},Gc=t=>{const e=t.changeEvent.id;if(t.keyDocumentMap)return t.keyDocumentMap.has(e);{const r=t.queryParams.primaryKey,n=t.previousResults;for(let o=0;o<n.length;o++)if(n[o][r]===e)return!0;return!1}},Yc=t=>{const e=t.previousResults[0];return!!(e&&e[t.queryParams.primaryKey]===t.changeEvent.id)},Zc=t=>{const e=Wr(t.previousResults);return!!(e&&e[t.queryParams.primaryKey]===t.changeEvent.id)},Xc=t=>{const e=t.changeEvent.previous;if(!e)return!1;const r=t.previousResults[0];return r?r[t.queryParams.primaryKey]===t.changeEvent.id?!0:t.queryParams.sortComparator(e,r)<0:!1},tu=t=>{const e=t.changeEvent.previous;if(!e)return!1;const r=Wr(t.previousResults);return r?r[t.queryParams.primaryKey]===t.changeEvent.id?!0:t.queryParams.sortComparator(e,r)>0:!1},eu=t=>{const e=t.changeEvent.doc;if(!e)return!1;const r=t.previousResults[0];return r?r[t.queryParams.primaryKey]===t.changeEvent.id?!0:t.queryParams.sortComparator(e,r)<0:!1},ru=t=>{const e=t.changeEvent.doc;if(!e)return!1;const r=Wr(t.previousResults);return r?r[t.queryParams.primaryKey]===t.changeEvent.id?!0:t.queryParams.sortComparator(e,r)>0:!1},nu=t=>{const e=t.changeEvent.previous;return e?t.queryParams.queryMatcher(e):!1},ou=t=>{const e=t.changeEvent.doc;return e?t.queryParams.queryMatcher(e):!1},iu=t=>t.previousResults.length===0,su={0:Kc,1:Uc,2:Hc,3:Zo,4:Wc,5:zc,6:iu,7:Vc,8:Yc,9:Zc,10:Jc,11:Gc,12:Xc,13:tu,14:eu,15:ru,16:nu,17:ou};function au(t,e,r,n){var o=t.length,i=o-1,s=0;if(o===0)return t.push(e),0;for(var a;n<=i;)s=n+(i-n>>1),a=t[s],r(a,e)<=0?n=s+1:i=s-1;return r(a,e)<=0&&s++,t.splice(s,0,e),s}const cu=t=>{},zr=t=>{t.previousResults.unshift(t.changeEvent.doc),t.keyDocumentMap&&t.keyDocumentMap.set(t.changeEvent.id,t.changeEvent.doc)},Hr=t=>{t.previousResults.push(t.changeEvent.doc),t.keyDocumentMap&&t.keyDocumentMap.set(t.changeEvent.id,t.changeEvent.doc)},Kr=t=>{const e=t.previousResults.shift();t.keyDocumentMap&&e&&t.keyDocumentMap.delete(e[t.queryParams.primaryKey])},Ur=t=>{const e=t.previousResults.pop();t.keyDocumentMap&&e&&t.keyDocumentMap.delete(e[t.queryParams.primaryKey])},uu=t=>{Kr(t),Hr(t)},lu=t=>{Ur(t),zr(t)},hu=t=>{Kr(t),zr(t)},fu=t=>{Ur(t),Hr(t)},Xo=t=>{t.keyDocumentMap&&t.keyDocumentMap.delete(t.changeEvent.id);const e=t.queryParams.primaryKey,r=t.previousResults;for(let n=0;n<r.length;n++)if(r[n][e]===t.changeEvent.id){r.splice(n,1);break}},du=t=>{const e=t.changeEvent.doc,r=t.queryParams.primaryKey,n=t.previousResults;for(let o=0;o<n.length;o++)if(n[o][r]===t.changeEvent.id){n[o]=e,t.keyDocumentMap&&t.keyDocumentMap.set(t.changeEvent.id,e);break}},pu=t=>{const e={_id:"wrongHuman"+new Date().getTime()};t.previousResults.length=0,t.previousResults.push(e),t.keyDocumentMap&&(t.keyDocumentMap.clear(),t.keyDocumentMap.set(e._id,e))},ti=t=>{const e=t.changeEvent.id,r=t.changeEvent.doc;if(t.keyDocumentMap){if(t.keyDocumentMap.has(e))return;t.keyDocumentMap.set(e,r)}else if(t.previousResults.find(n=>n[t.queryParams.primaryKey]===e))return;au(t.previousResults,r,t.queryParams.sortComparator,0)},mu=t=>{Xo(t),ti(t)},vu=t=>{throw new Error("Action runFullQueryAgain must be implemented by yourself")},yu=t=>{throw new Error("Action unknownAction should never be called")},gu=["doNothing","insertFirst","insertLast","removeFirstItem","removeLastItem","removeFirstInsertLast","removeLastInsertFirst","removeFirstInsertFirst","removeLastInsertLast","removeExisting","replaceExisting","alwaysWrong","insertAtSortPosition","removeExistingAndInsertAtSortPosition","runFullQueryAgain","unknownAction"],bu={doNothing:cu,insertFirst:zr,insertLast:Hr,removeFirstItem:Kr,removeLastItem:Ur,removeFirstInsertLast:uu,removeLastInsertFirst:lu,removeFirstInsertFirst:hu,removeLastInsertLast:fu,removeExisting:Xo,replaceExisting:du,alwaysWrong:pu,insertAtSortPosition:ti,removeExistingAndInsertAtSortPosition:mu,runFullQueryAgain:vu,unknownAction:yu},wu=40;function Vr(t){return t.charCodeAt(0)-wu}function _u(t){return t?"1":"0"}function ei(t,e){const r=[];for(let n=0,o=t.length;n<o;n+=e)r.push(t.substring(n,n+e));return r}function ku(t){const e=new Map,r=2+parseInt(t.charAt(0)+t.charAt(1),10)*2,n=t.substring(2,r),o=ei(n,2);for(let d=0;d<o.length;d++){const p=o[d],m=p.charAt(0),y=Vr(p.charAt(1));e.set(m,y)}const i=t.substring(r,t.length-3),s=ei(i,4);for(let d=0;d<s.length;d++){const p=s[d],m=p.charAt(0),y=p.charAt(1),g=p.charAt(2),w=Vr(p.charAt(3));if(!e.has(y))throw new Error("missing node with id "+y);if(!e.has(g))throw new Error("missing node with id "+g);const _=e.get(y),A=e.get(g),x={l:w,0:_,1:A};e.set(m,x)}const a=t.slice(-3),c=a.charAt(0),l=a.charAt(1),u=Vr(a.charAt(2)),h=e.get(c),f=e.get(l);return{l:u,0:h,1:f}}function xu(t,e,r){let n=t,o=t.l;for(;;){const i=e[o](r),s=_u(i);if(n=n[s],typeof n=="number"||typeof n=="string")return n;o=n.l}}const Ou="14a1b,c+d2e5f0g/h.i4j*k-l)m(n6oeh6pnm6qen6ril6snh6tin6ubo9vce9wmh9xns9yne9zmi9{cm9|ad9}cp9~aq9\x7Fae9\xA1bf9\xA2bq9\xA3cg9\xA4ck9\xA5cn9\xA6nd9\xA7np9\xA8nq9\xA9nf9\xAAng9\xABnm9\xACnk9\xADmr9\xAEms9\xAFmt9\xB0mj9\xB1mk9\xB2ml9\xB3mn9\xB4mc8\xB5\xB3{8\xB6\xAF}8\xB7\xB0\xA48\xB8\xB3\xA78\xB9mn8\xBA\xB3\xAB8\xBB\xB3m8\xBCm\xB44\xBDz\xB24\xBE\xB3w4\xBFz\xB54\xC0\xAF\xB64\xC1\xB0\xB74\xC2\xB3\xBA4\xC3\xB3\xB84\xC4m\xB94\xC5v\xA47\xC6yn7\xC7\xC0\xC17\xC8~\x7F7\xC9\xA5\xA47\xCA\xC3\xC47\xCB\xA8n7\xCC\xBA\xB97\xCD\xAD\xB07\xCE\xAEm7\xCF\xAF\xB07\xD0\xB1m7\xD1\xB3m7\xD2\xBCm5\xD3\xC4m5\xD4\xB9m5\xD5\xBD\xB05\xD6\xBEm5\xD7\xBF\xB05\xD8\xC7\xCF5\xD9\xC2m5\xDA\xCA\xD15\xDB\xB1m5\xDC\xBAm5\xDD\xCC\xD15\xDE\xD5\xCD2\xDF|\x7F2\xE0\xA1u2\xE1\xA3\xC52\xE2\xD6\xCE2\xE3\xA6\xC62\xE4\xA9x2\xE5\xAA\xC62\xE6\xD7\xD82\xE7|\xC82\xE8\xA1\xA22\xE9\xA3\xC92\xEA\xA4\xA52\xEB\xD9\xDA2\xEC\xA6\xCB2\xED\xA9n2\xEE\xAAn2\xEF\xDB\xD02\xF0\xDC\xDD2\xF1\xACn2\xF2\xD2\xD3/\xF3an/\xF4bn/\xF5cn/\xF6\xDE\xE2/\xF7\xDF\xE3/\xF8\xE0\xE4/\xF9\xE1\xE5/\xFA\xE6\xEB/\xFB\xE7\xEC/\xFC\xE8\xED/\xFD\xE9\xEE/\xFE\xCD\xCE/\xFF\xCF\xD1/\u0100\xF2\xD4,\u0101cn,\u0102\xF6\xEF,\u0103\xA4\xF1,\u0104\xFA\xF0,\u0105\xEA\xF1,\u0106\xFE\xD0,\u0107\xFF\xD1,\u0108ac0\u0109bc0\u010A\xF3\xF50\u010B\xF4\u01010\u010C\xDF\xE10\u010D\xE0\xA40\u010E\xE7\xE90\u010F\xE8\xEA0\u0110\xF7\xF90\u0111\xF8\u01030\u0112\xFB\xFD0\u0113\xFC\u01050\u0114m\xD2-\u0115m\u0100-\u0116\xDE\xE6-\u0117\u010C\u010E-\u0118\u010D\u010F-\u0119\u0102\u0104-\u011A\u0110\u0112-\u011B\u0111\u0113-\u011C\xB2\xBB-\u011D\xCD\xCF-\u011E\u0106\u0107-\u011F\xB2\xB3-\u0120\u0114\u01083\u0121\u0115\u010A3\u0122\u0116\u01173\u0123\u0119\u011A3\u0124\u0122\u011D(\u0125\u011C\u011F(\u0126\u0123\u011E(\u0127\u0120\u0121+\u0128\u0109\u010B+\u0129\u0124\u0126+\u012A\u0118\u011B+\u012B\u0127\u01281\u012C\u0129\u012A1\u012D\u012C\u012B*\u012E\u0125m*\u012D\u012E.";let Jr;function Eu(){return Jr||(Jr=ku(Ou)),Jr}const Du=t=>xu(Eu(),su,t);function Iu(t){const e=Du(t);return gu[e]}function Pu(t,e,r,n,o){const i=bu[t];return i({queryParams:e,changeEvent:r,previousResults:n,keyDocumentMap:o}),n}function Su(t,e){return!e.sort||e.sort.length===0?[t]:e.sort.map(r=>Object.keys(r)[0])}var Cu=new WeakMap;function ju(t){return G(Cu,t,()=>{var e=t.collection,r=Ye(e.storageInstance.schema,Mt(t.mangoQuery)),n=e.schema.primaryPath,o=zo(e.schema.jsonSchema,r),i=(l,u)=>{var h={docA:l,docB:u};return o(h.docA,h.docB)},s=Lr(e.schema.jsonSchema,r),a=l=>{var u={doc:l};return s(u.doc)},c={primaryKey:t.collection.schema.primaryPath,skip:r.skip,limit:r.limit,sortFields:Su(n,r),sortComparator:i,queryMatcher:a};return c})}function Ru(t,e){if(!t.collection.database.eventReduce)return{runFullQueryAgain:!0};for(var r=ju(t),n=P(t._result).docsData.slice(0),o=P(t._result).docsDataMap,i=!1,s=[],a=0;a<e.length;a++){var c=e[a],l=va(c);l&&s.push(l)}var u=s.find(h=>{var f={queryParams:r,changeEvent:h,previousResults:n,keyDocumentMap:o},d=Iu(f);if(d==="runFullQueryAgain")return!0;if(d!=="doNothing")return i=!0,Pu(d,r,h,n,o),!1});return u?{runFullQueryAgain:!0}:{runFullQueryAgain:!1,changed:i,newResults:n}}var Mu=(function(){function t(){this._map=new Map}var e=t.prototype;return e.getByQuery=function(r){var n=r.toString(),o=G(this._map,n,()=>r);return o},t})();function $u(){return new Mu}function ri(t,e){e.uncached=!0;var r=e.toString();t._map.delete(r)}function Au(t){return t.refCount$.observers.length}var qu=100,Nu=30*1e3,Tu=(t,e)=>(r,n)=>{if(!(n._map.size<t)){var o=gt()-e,i=[],s=Array.from(n._map.values());for(var a of s)if(!(Au(a)>0)){if(a._lastEnsureEqual===0&&a._creationTime<o){ri(n,a);continue}i.push(a)}var c=i.length-t;if(!(c<=0)){var l=i.sort((h,f)=>h._lastEnsureEqual-f._lastEnsureEqual),u=l.slice(0,c);u.forEach(h=>ri(n,h))}}},ni=Tu(qu,Nu),Gr=new WeakSet;function Bu(t){Gr.has(t)||(Gr.add(t),ms().then(()=>gs(200)).then(()=>{t.closed||t.cacheReplacementPolicy(t,t._queryCache),Gr.delete(t)}))}var Lu=(function(){function t(r,n,o){this.cacheItemByDocId=new Map,this.tasks=new Set,this.registry=typeof FinalizationRegistry=="function"?new FinalizationRegistry(i=>{var s=i.docId,a=this.cacheItemByDocId.get(s);a&&(a[0].delete(i.revisionHeight+i.lwt+""),a[0].size===0&&this.cacheItemByDocId.delete(s))}):void 0,this.primaryPath=r,this.changes$=n,this.documentCreator=o,n.subscribe(i=>{this.tasks.add(()=>{for(var s=this.cacheItemByDocId,a=0;a<i.length;a++){var c=i[a],l=s.get(c.documentId);if(l){var u=c.documentData;u||(u=c.previousDocumentData),l[1]=u}}}),this.tasks.size<=1&&Ne().then(()=>{this.processTasks()})})}var e=t.prototype;return e.processTasks=function(){if(this.tasks.size!==0){var r=Array.from(this.tasks);r.forEach(n=>n()),this.tasks.clear()}},e.getLatestDocumentData=function(r){this.processTasks();var n=Be(this.cacheItemByDocId,r);return n[1]},e.getLatestDocumentDataIfExists=function(r){this.processTasks();var n=this.cacheItemByDocId.get(r);if(n)return n[1]},at(t,[{key:"getCachedRxDocuments",get:function(){var r=oi(this);return X(this,"getCachedRxDocuments",r)}},{key:"getCachedRxDocument",get:function(){var r=oi(this);return X(this,"getCachedRxDocument",n=>r([n])[0])}}])})();function oi(t){var e=t.primaryPath,r=t.cacheItemByDocId,n=t.registry,o=j.deepFreezeWhenDevMode,i=t.documentCreator,s=a=>{for(var c=new Array(a.length),l=[],u=0;u<a.length;u++){var h=a[u],f=h[e],d=Xt(h._rev),p=void 0,m=void 0,y=r.get(f);y?(p=y[0],m=p.get(d+h._meta.lwt+"")):(p=new Map,y=[p,h],r.set(f,y));var g=m?m.deref():void 0;g||(h=o(h),g=i(h),p.set(d+h._meta.lwt+"",Qu(g)),n&&l.push(g)),c[u]=g}return l.length>0&&n&&(t.tasks.add(()=>{for(var w=0;w<l.length;w++){var _=l[w];n.register(_,{docId:_.primary,revisionHeight:Xt(_.revision),lwt:_._data._meta.lwt})}}),t.tasks.size<=1&&Ne().then(()=>{t.processTasks()})),c};return s}function Yr(t,e){var r=t.getCachedRxDocuments;return r(e)}var Fu=typeof WeakRef=="function",Qu=Fu?Wu:zu;function Wu(t){return new WeakRef(t)}function zu(t){return{deref(){return t}}}var ii=(function(){function t(r,n,o){this.time=gt(),this.query=r,this.count=o,this.documents=Yr(this.query.collection._docCache,n)}var e=t.prototype;return e.getValue=function(r){var n=this.query.op;if(n==="count")return this.count;if(n==="findOne"){var o=this.documents.length===0?null:this.documents[0];if(!o&&r)throw b("QU10",{collection:this.query.collection.name,query:this.query.mangoQuery,op:n});return o}else return n==="findByIds"?this.docsMap:this.documents.slice(0)},at(t,[{key:"docsData",get:function(){return X(this,"docsData",this.documents.map(r=>r._data))}},{key:"docsDataMap",get:function(){var r=new Map;return this.documents.forEach(n=>{r.set(n.primary,n._data)}),X(this,"docsDataMap",r)}},{key:"docsMap",get:function(){for(var r=new Map,n=this.documents,o=0;o<n.length;o++){var i=n[o];r.set(i.primary,i)}return X(this,"docsMap",r)}}])})(),Hu=0,Ku=function(){return++Hu},si=(function(){function t(r,n,o,i={}){this.id=Ku(),this._execOverDatabaseCount=0,this._creationTime=gt(),this._lastEnsureEqual=0,this.uncached=!1,this.refCount$=new fa(null),this._result=null,this._latestChangeEvent=-1,this._ensureEqualQueue=$t,this.op=r,this.mangoQuery=n,this.collection=o,this.other=i,n||(this.mangoQuery=er()),this.isFindOneByIdQuery=Gu(this.collection.schema.primaryPath,n)}var e=t.prototype;return e._setResultData=function(r){if(typeof r>"u")throw b("QU18",{database:this.collection.database.name,collection:this.collection.name});if(typeof r=="number"){this._result=new ii(this,[],r);return}else r instanceof Map&&(r=Array.from(r.values()));var n=new ii(this,r,r.length);this._result=n},e._execOverDatabase=async function(){if(this._execOverDatabaseCount=this._execOverDatabaseCount+1,this.op==="count"){var r=this.getPreparedQuery(),n=await this.collection.storageInstance.count(r);if(n.mode==="slow"&&!this.collection.database.allowSlowCount)throw b("QU14",{collection:this.collection,queryObj:this.mangoQuery});return n.count}if(this.op==="findByIds"){var o=P(this.mangoQuery.selector)[this.collection.schema.primaryPath].$in,i=new Map,s=[];if(o.forEach(l=>{var u=this.collection._docCache.getLatestDocumentDataIfExists(l);if(u){if(!u._deleted){var h=this.collection._docCache.getCachedRxDocument(u);i.set(l,h)}}else s.push(l)}),s.length>0){var a=await this.collection.storageInstance.findDocumentsById(s,!1);a.forEach(l=>{var u=this.collection._docCache.getCachedRxDocument(l);i.set(u.primary,u)})}return i}var c=Ju(this);return c.then(l=>l)},e.exec=async function(r){if(r&&this.op!=="findOne")throw b("QU9",{collection:this.collection.name,query:this.mangoQuery,op:this.op});await ci(this);var n=P(this._result);return n.getValue(r)},e.toString=function(){var r=Re({op:this.op,query:Ye(this.collection.schema.jsonSchema,this.mangoQuery),other:this.other},!0),n=JSON.stringify(r);return this.toString=()=>n,n},e.getPreparedQuery=function(){var r={rxQuery:this,mangoQuery:Ye(this.collection.schema.jsonSchema,this.mangoQuery)};r.mangoQuery.selector._deleted={$eq:!1},r.mangoQuery.index&&r.mangoQuery.index.unshift("_deleted"),B("prePrepareQuery",r);var n=Fr(this.collection.schema.jsonSchema,r.mangoQuery);return this.getPreparedQuery=()=>n,n},e.doesDocumentDataMatch=function(r){return r._deleted?!1:this.queryMatcher(r)},e.remove=async function(){var r=await this.exec();if(Array.isArray(r)){var n=await this.collection.bulkRemove(r);if(n.error.length>0)throw Sn(n.error[0]);return n.success}else return r.remove()},e.incrementalRemove=function(){return ge(this.asRxQuery,r=>r.incrementalRemove())},e.update=function(r){throw E("update")},e.patch=function(r){return ge(this.asRxQuery,n=>n.patch(r))},e.incrementalPatch=function(r){return ge(this.asRxQuery,n=>n.incrementalPatch(r))},e.modify=function(r){return ge(this.asRxQuery,n=>n.modify(r))},e.incrementalModify=function(r){return ge(this.asRxQuery,n=>n.incrementalModify(r))},e.where=function(r){throw E("query-builder")},e.sort=function(r){throw E("query-builder")},e.skip=function(r){throw E("query-builder")},e.limit=function(r){throw E("query-builder")},at(t,[{key:"$",get:function(){if(!this._$){var r=this.collection.eventBulks$.pipe(U(n=>!n.isLocal),yo(null),ae(()=>ci(this)),Z(()=>this._result),vo(An),Cr((n,o)=>!!(n&&n.time===P(o).time)),U(n=>!!n),Z(n=>P(n).getValue()));this._$=ga(r,this.refCount$.pipe(U(()=>!1)))}return this._$}},{key:"$$",get:function(){var r=this.collection.database.getReactivityFactory();return r.fromObservable(this.$,void 0,this.collection.database)}},{key:"queryMatcher",get:function(){var r=this.collection.schema.jsonSchema,n=Ye(this.collection.schema.jsonSchema,this.mangoQuery);return X(this,"queryMatcher",Lr(r,n))}},{key:"asRxQuery",get:function(){return this}}])})();function er(){return{selector:{}}}function Uu(t){return t.collection._queryCache.getByQuery(t)}function Wt(t,e,r,n){B("preCreateRxQuery",{op:t,queryObj:e,collection:r,other:n});var o=new si(t,e,r,n);return o=Uu(o),Bu(r),o}function ai(t){var e=t.asRxQuery.collection._changeEventBuffer.getCounter();return t._latestChangeEvent>=e}async function ci(t){return t.collection.awaitBeforeReads.size>0&&await Promise.all(Array.from(t.collection.awaitBeforeReads).map(e=>e())),t.collection.database.closed||ai(t)?!1:(t._ensureEqualQueue=t._ensureEqualQueue.then(()=>Vu(t)),t._ensureEqualQueue)}function Vu(t){if(t._lastEnsureEqual=gt(),t.collection.database.closed||ai(t))return $t;var e=!1,r=!1;if(t._latestChangeEvent===-1&&(r=!0),!r){var n=t.asRxQuery.collection._changeEventBuffer.getFrom(t._latestChangeEvent+1);if(n===null)r=!0;else{t._latestChangeEvent=t.asRxQuery.collection._changeEventBuffer.getCounter();var o=t.asRxQuery.collection._changeEventBuffer.reduceByLastOfDoc(n);if(t.op==="count"){var i=P(t._result).count,s=i;o.forEach(c=>{var l=c.previousDocumentData&&t.doesDocumentDataMatch(c.previousDocumentData),u=t.doesDocumentDataMatch(c.documentData);!l&&u&&s++,l&&!u&&s--}),s!==i&&(e=!0,t._setResultData(s))}else{var a=Ru(t,o);a.runFullQueryAgain?r=!0:a.changed&&(e=!0,t._setResultData(a.newResults))}}}return r?t._execOverDatabase().then(c=>(t._latestChangeEvent=t.collection._changeEventBuffer.getCounter(),typeof c=="number"?((!t._result||c!==t._result.count)&&(e=!0,t._setResultData(c)),e):((!t._result||!is(t.collection.schema.primaryPath,c,t._result.docsData))&&(e=!0,t._setResultData(c)),e))):Promise.resolve(e)}async function Ju(t){var e=[],r=t.collection;if(t.isFindOneByIdQuery)if(Array.isArray(t.isFindOneByIdQuery)){var n=t.isFindOneByIdQuery;if(n=n.filter(u=>{var h=t.collection._docCache.getLatestDocumentDataIfExists(u);return h?(h._deleted||e.push(h),!1):!0}),n.length>0){var o=await r.storageInstance.findDocumentsById(n,!1);Rt(e,o)}}else{var i=t.isFindOneByIdQuery,s=t.collection._docCache.getLatestDocumentDataIfExists(i);if(!s){var a=await r.storageInstance.findDocumentsById([i],!1);a[0]&&(s=a[0])}s&&!s._deleted&&e.push(s)}else{var c=t.getPreparedQuery(),l=await r.storageInstance.query(c);e=l.documents}return e}function Gu(t,e){if(!e.skip&&e.selector&&Object.keys(e.selector).length===1&&e.selector[t]){var r=e.selector[t];if(typeof r=="string")return r;if(Object.keys(r).length===1&&typeof r.$eq=="string"||Object.keys(r).length===1&&Array.isArray(r.$eq)&&!r.$eq.find(n=>typeof n!="string"))return r.$eq}return!1}var be="collection",Zr="storage-token",Yu="rx-migration-status",Zu="rx-pipeline-checkpoint",Xu="RxInternalDocument",Xr=Fn({version:0,title:Xu,primaryKey:{key:"id",fields:["context","key"],separator:"|"},type:"object",properties:{id:{type:"string",maxLength:200},key:{type:"string"},context:{type:"string",enum:[be,Zr,Yu,Zu,"OTHER"]},data:{type:"object",additionalProperties:!0}},indexes:[],required:["key","context","data"],additionalProperties:!1,sharding:{shards:1,mode:"collection"}});function tn(t,e){return kr(Xr,{key:t,context:e})}async function ui(t){var e=Fr(t.schema,{selector:{context:be,_deleted:{$eq:!1}},sort:[{id:"asc"}],skip:0}),r=await t.query(e),n=r.documents;return n}var li="storageToken",tl=tn(li,Zr);async function el(t){var e=Te(10),r=t.password?await t.hashFunction(JSON.stringify(t.password)):void 0,n={id:tl,context:Zr,key:li,data:{rxdbVersion:t.rxdbVersion,token:e,instanceToken:t.token,passwordHash:r},_deleted:!1,_meta:fr(),_rev:dr(),_attachments:{}},o=[{document:n}],i=await t.internalStore.bulkWrite(o,"internal-add-storage-token");if(!i.error[0])return Dt("id",o,i)[0];var s=P(i.error[0]);if(s.isError&&Pn(s)){var a=s;if(!rl(a.documentInDb.data.rxdbVersion,t.rxdbVersion))throw b("DM5",{args:{database:t.name,databaseStateVersion:a.documentInDb.data.rxdbVersion,codeVersion:t.rxdbVersion}});if(r&&r!==a.documentInDb.data.passwordHash)throw b("DB1",{passwordHash:r,existingPasswordHash:a.documentInDb.data.passwordHash});var c=a.documentInDb;return P(c)}throw s}function rl(t,e){if(!t)return!1;var r=t.split(".")[0],n=e.split(".")[0];return r==="15"&&n==="16"?!0:r===n}function hi(t,e){return t+"-"+e.version}function rr(t,e){return e=T(e),e=js(t,e),typeof t.jsonSchema.primaryKey!="string"&&(e=Ln(t.primaryPath,t.jsonSchema,e)),e._meta=fr(),Object.prototype.hasOwnProperty.call(e,"_deleted")||(e._deleted=!1),Object.prototype.hasOwnProperty.call(e,"_attachments")||(e._attachments={}),Object.prototype.hasOwnProperty.call(e,"_rev")||(e._rev=dr()),e}async function nl(t,e){e.multiInstance=t.multiInstance;var r=await t.storage.createStorageInstance(e);return r}async function fi(t,e,r,n,o,i,s,a){var c=await ui(e),l=c.filter(d=>d.data.name===o),u=[];l.forEach(d=>{u.push({collectionName:d.data.name,schema:d.data.schema,isCollection:!0}),d.data.connectedStorages.forEach(p=>u.push({collectionName:p.collectionName,isCollection:!1,schema:p.schema}))});var h=new Set;if(u=u.filter(d=>{var p=d.collectionName+"||"+d.schema.version;return h.has(p)?!1:(h.add(p),!0)}),await Promise.all(u.map(async d=>{var p=await t.createStorageInstance({collectionName:d.collectionName,databaseInstanceToken:r,databaseName:n,multiInstance:i,options:{},schema:d.schema,password:s,devMode:j.isDevMode()});await p.remove(),d.isCollection&&await oe("postRemoveRxCollection",{storage:t,databaseName:n,collectionName:o})})),a){var f=l.map(d=>{var p=Xe(d);return p._deleted=!0,p._meta.lwt=gt(),p._rev=lr(r,d),{previous:d,document:p}});await e.bulkWrite(f,"rx-database-remove-collection-all")}}function V(t){if(t.closed)throw b("COL21",{collection:t.name,version:t.schema.version})}var ol=(function(){function t(r){this.subs=[],this.counter=0,this.eventCounterMap=new WeakMap,this.buffer=[],this.limit=100,this.tasks=new Set,this.collection=r,this.subs.push(this.collection.eventBulks$.pipe(U(n=>!n.isLocal)).subscribe(n=>{this.tasks.add(()=>this._handleChangeEvents(n.events)),this.tasks.size<=1&&Ne().then(()=>{this.processTasks()})}))}var e=t.prototype;return e.processTasks=function(){if(this.tasks.size!==0){var r=Array.from(this.tasks);r.forEach(n=>n()),this.tasks.clear()}},e._handleChangeEvents=function(r){var n=this.counter;this.counter=this.counter+r.length,r.length>this.limit?this.buffer=r.slice(r.length*-1):(Rt(this.buffer,r),this.buffer=this.buffer.slice(this.limit*-1));for(var o=n+1,i=this.eventCounterMap,s=0;s<r.length;s++){var a=r[s];i.set(a,o+s)}},e.getCounter=function(){return this.processTasks(),this.counter},e.getBuffer=function(){return this.processTasks(),this.buffer},e.getArrayIndexByPointer=function(r){this.processTasks();var n=this.buffer[0],o=this.eventCounterMap.get(n);if(r<o)return null;var i=r-o;return i},e.getFrom=function(r){this.processTasks();var n=[],o=this.getArrayIndexByPointer(r);if(o===null)return null;for(;;){var i=this.buffer[o];if(o++,i)n.push(i);else return n}},e.runFrom=function(r,n){this.processTasks();var o=this.getFrom(r);if(o===null)throw new Error("out of bounds");o.forEach(i=>n(i))},e.reduceByLastOfDoc=function(r){return this.processTasks(),r.slice(0)},e.close=function(){this.tasks.clear(),this.subs.forEach(r=>r.unsubscribe())},t})();function il(t){return new ol(t)}var sl=new WeakMap;function al(t){var e=t.schema.getDocumentPrototype(),r=ll(t),n=tr,o={};return[e,r,n].forEach(i=>{var s=Object.getOwnPropertyNames(i);s.forEach(a=>{var c=Object.getOwnPropertyDescriptor(i,a),l=!0;(a.startsWith("_")||a.endsWith("_")||a.startsWith("$")||a.endsWith("$"))&&(l=!1),typeof c.value=="function"?Object.defineProperty(o,a,{get(){return c.value.bind(this)},enumerable:l,configurable:!1}):(c.enumerable=l,c.configurable=!1,c.writable&&(c.writable=!1),Object.defineProperty(o,a,c))})}),o}function cl(t){return G(sl,t,()=>Vo(al(t)))}function ul(t,e,r){var n=Lc(e,t,j.deepFreezeWhenDevMode(r));return t._runHooksSync("post","create",r,n),B("postCreateRxDocument",n),n}function ll(t){var e={};return Object.entries(t.methods).forEach(([r,n])=>{e[r]=n}),e}var di={isEqual(t,e,r){t=pi(t),e=pi(e);var n=ee(et(t),et(e));return n},resolve(t){return t.realMasterState}};function pi(t){return t._attachments||(t=T(t),t._attachments={}),t}var mi=["pre","post"],vi=["insert","save","remove","create"],yi=!1,zt=new Set,en=(function(){function t(r,n,o,i,s={},a={},c={},l={},u={},h=ni,f={},d=di){this.storageInstance={},this.timeouts=new Set,this.incrementalWriteQueue={},this.awaitBeforeReads=new Set,this._incrementalUpsertQueues=new Map,this.synced=!1,this.hooks={},this._subs=[],this._docCache={},this._queryCache=$u(),this.$={},this.checkpoint$={},this._changeEventBuffer={},this.eventBulks$={},this.onClose=[],this.closed=!1,this.onRemove=[],this.database=r,this.name=n,this.schema=o,this.internalStorageInstance=i,this.instanceCreationOptions=s,this.migrationStrategies=a,this.methods=c,this.attachments=l,this.options=u,this.cacheReplacementPolicy=h,this.statics=f,this.conflictHandler=d,hl(this.asRxCollection),r&&(this.eventBulks$=r.eventBulks$.pipe(U(p=>p.collectionName===this.name))),this.database&&zt.add(this)}var e=t.prototype;return e.prepare=async function(){if(!await Bn()){for(var r=0;r<10&&zt.size>_r;)r++,await this.promiseWait(30);if(zt.size>_r)throw b("COL23",{database:this.database.name,collection:this.name,args:{existing:Array.from(zt.values()).map(a=>({db:a.database?a.database.name:"",c:a.name}))}})}this.storageInstance=Ho(this.database,this.internalStorageInstance,this.schema.jsonSchema),this.incrementalWriteQueue=new Tc(this.storageInstance,this.schema.primaryPath,(a,c)=>Jo(this,a,c),a=>this._runHooks("post","save",a)),this.$=this.eventBulks$.pipe(ae(a=>go(a))),this.checkpoint$=this.eventBulks$.pipe(Z(a=>a.checkpoint)),this._changeEventBuffer=il(this.asRxCollection);var n;this._docCache=new Lu(this.schema.primaryPath,this.eventBulks$.pipe(U(a=>!a.isLocal),Z(a=>a.events)),a=>(n||(n=cl(this.asRxCollection)),ul(this.asRxCollection,n,a)));var o=this.database.internalStore.changeStream().pipe(U(a=>{var c=this.name+"-"+this.schema.version,l=a.events.find(u=>u.documentData.context==="collection"&&u.documentData.key===c&&u.operation==="DELETE");return!!l})).subscribe(async()=>{await this.close(),await Promise.all(this.onRemove.map(a=>a()))});this._subs.push(o);var i=await this.database.storageToken,s=this.storageInstance.changeStream().subscribe(a=>{var c={id:a.id,isLocal:!1,internal:!1,collectionName:this.name,storageToken:i,events:a.events,databaseToken:this.database.token,checkpoint:a.checkpoint,context:a.context};this.database.$emit(c)});return this._subs.push(s),qe},e.cleanup=function(r){throw V(this),E("cleanup")},e.migrationNeeded=function(){throw E("migration-schema")},e.getMigrationState=function(){throw E("migration-schema")},e.startMigration=function(r=10){return V(this),this.getMigrationState().startMigration(r)},e.migratePromise=function(r=10){return this.getMigrationState().migratePromise(r)},e.insert=async function(r){V(this);var n=await this.bulkInsert([r]),o=n.error[0];Ze(this,r[this.schema.primaryPath],r,o);var i=P(n.success[0]);return i},e.insertIfNotExists=async function(r){var n=await this.bulkInsert([r]);if(n.error.length>0){var o=n.error[0];if(o.status===409){var i=o.documentInDb;return Yr(this._docCache,[i])[0]}else throw o}return n.success[0]},e.bulkInsert=async function(r){if(V(this),r.length===0)return{success:[],error:[]};var n=this.schema.primaryPath,o=new Set,i;if(this.hasHooks("pre","insert"))i=await Promise.all(r.map(m=>{var y=rr(this.schema,m);return this._runHooks("pre","insert",y).then(()=>(o.add(y[n]),{document:y}))}));else{i=new Array(r.length);for(var s=this.schema,a=0;a<r.length;a++){var c=r[a],l=rr(s,c);o.add(l[n]),i[a]={document:l}}}if(o.size!==r.length)throw b("COL22",{collection:this.name,args:{documents:r}});var u=await this.storageInstance.bulkWrite(i,"rx-collection-bulk-insert"),h,f=this,d={get success(){if(!h){var m=Dt(f.schema.primaryPath,i,u);h=Yr(f._docCache,m)}return h},error:u.error};if(this.hasHooks("post","insert")){var p=new Map;i.forEach(m=>{var y=m.document;p.set(y[n],y)}),await Promise.all(d.success.map(m=>this._runHooks("post","insert",p.get(m.primary),m)))}return d},e.bulkRemove=async function(r){V(this);var n=this.schema.primaryPath;if(r.length===0)return{success:[],error:[]};var o;typeof r[0]=="string"?o=await this.findByIds(r).exec():(o=new Map,r.forEach(f=>o.set(f.primary,f)));var i=[],s=new Map;Array.from(o.values()).forEach(f=>{var d=f.toMutableJSON(!0);i.push(d),s.set(f.primary,d)}),await Promise.all(i.map(f=>{var d=f[this.schema.primaryPath];return this._runHooks("pre","remove",f,o.get(d))}));var a=i.map(f=>{var d=T(f);return d._deleted=!0,{previous:f,document:d}}),c=await this.storageInstance.bulkWrite(a,"rx-collection-bulk-remove"),l=Dt(this.schema.primaryPath,a,c),u=[],h=l.map(f=>{var d=f[n],p=this._docCache.getCachedRxDocument(f);return u.push(p),d});return await Promise.all(h.map(f=>this._runHooks("post","remove",s.get(f),o.get(f)))),{success:u,error:c.error}},e.bulkUpsert=async function(r){V(this);var n=[],o=new Map;r.forEach(c=>{var l=rr(this.schema,c),u=l[this.schema.primaryPath];if(!u)throw b("COL3",{primaryPath:this.schema.primaryPath,data:l,schema:this.schema.jsonSchema});o.set(u,l),n.push(l)});var i=await this.bulkInsert(n),s=i.success.slice(0),a=[];return await Promise.all(i.error.map(async c=>{if(c.status!==409)a.push(c);else{var l=c.documentId,u=Be(o,l),h=P(c.documentInDb),f=this._docCache.getCachedRxDocuments([h])[0],d=await f.incrementalModify(()=>u);s.push(d)}})),{error:a,success:s}},e.upsert=async function(r){V(this);var n=await this.bulkUpsert([r]);return Ze(this.asRxCollection,r[this.schema.primaryPath],r,n.error[0]),n.success[0]},e.incrementalUpsert=function(r){V(this);var n=rr(this.schema,r),o=n[this.schema.primaryPath];if(!o)throw b("COL4",{data:r});var i=this._incrementalUpsertQueues.get(o);return i||(i=qe),i=i.then(()=>dl(this,o,n)).then(s=>s.inserted?s.doc:fl(s.doc,n)),this._incrementalUpsertQueues.set(o,i),i},e.find=function(r){V(this),B("prePrepareRxQuery",{op:"find",queryObj:r,collection:this}),r||(r=er());var n=Wt("find",r,this);return n},e.findOne=function(r){V(this),B("prePrepareRxQuery",{op:"findOne",queryObj:r,collection:this});var n;if(typeof r=="string")n=Wt("findOne",{selector:{[this.schema.primaryPath]:r},limit:1},this);else{if(r||(r=er()),r.limit)throw b("QU6");r=T(r),r.limit=1,n=Wt("findOne",r,this)}return n},e.count=function(r){V(this),r||(r=er());var n=Wt("count",r,this);return n},e.findByIds=function(r){V(this);var n={selector:{[this.schema.primaryPath]:{$in:r.slice(0)}}},o=Wt("findByIds",n,this);return o},e.exportJSON=function(){throw E("json-dump")},e.importJSON=function(r){throw E("json-dump")},e.insertCRDT=function(r){throw E("crdt")},e.addPipeline=function(r){throw E("pipeline")},e.addHook=function(r,n,o,i=!1){if(typeof o!="function")throw $e("COL7",{key:n,when:r});if(!mi.includes(r))throw $e("COL8",{key:n,when:r});if(!vi.includes(n))throw b("COL9",{key:n});if(r==="post"&&n==="create"&&i===!0)throw b("COL10",{when:r,key:n,parallel:i});var s=o.bind(this),a=i?"parallel":"series";this.hooks[n]=this.hooks[n]||{},this.hooks[n][r]=this.hooks[n][r]||{series:[],parallel:[]},this.hooks[n][r][a].push(s)},e.getHooks=function(r,n){return!this.hooks[n]||!this.hooks[n][r]?{series:[],parallel:[]}:this.hooks[n][r]},e.hasHooks=function(r,n){if(!this.hooks[n]||!this.hooks[n][r])return!1;var o=this.getHooks(r,n);return o?o.series.length>0||o.parallel.length>0:!1},e._runHooks=function(r,n,o,i){var s=this.getHooks(r,n);if(!s)return qe;var a=s.series.map(c=>()=>c(o,i));return ws(a).then(()=>Promise.all(s.parallel.map(c=>c(o,i))))},e._runHooksSync=function(r,n,o,i){if(this.hasHooks(r,n)){var s=this.getHooks(r,n);s&&s.series.forEach(a=>a(o,i))}},e.promiseWait=function(r){var n=new Promise(o=>{var i=setTimeout(()=>{this.timeouts.delete(i),o()},r);this.timeouts.add(i)});return n},e.close=async function(){return this.closed?$t:(zt.delete(this),await Promise.all(this.onClose.map(r=>r())),this.closed=!0,Array.from(this.timeouts).forEach(r=>clearTimeout(r)),this._changeEventBuffer&&this._changeEventBuffer.close(),this.database.requestIdlePromise().then(()=>this.storageInstance.close()).then(()=>(this._subs.forEach(r=>r.unsubscribe()),delete this.database.collections[this.name],oe("postCloseRxCollection",this).then(()=>!0))))},e.remove=async function(){await this.close(),await Promise.all(this.onRemove.map(r=>r())),await fi(this.database.storage,this.database.internalStore,this.database.token,this.database.name,this.name,this.database.multiInstance,this.database.password,this.database.hashFunction)},at(t,[{key:"insert$",get:function(){return this.$.pipe(U(r=>r.operation==="INSERT"))}},{key:"update$",get:function(){return this.$.pipe(U(r=>r.operation==="UPDATE"))}},{key:"remove$",get:function(){return this.$.pipe(U(r=>r.operation==="DELETE"))}},{key:"asRxCollection",get:function(){return this}}])})();function hl(t){if(!yi){yi=!0;var e=Object.getPrototypeOf(t);vi.forEach(r=>{mi.map(n=>{var o=n+Rn(r);e[o]=function(i,s){return this.addHook(n,r,i,s)}})})}}function fl(t,e){return t.incrementalModify(r=>e)}function dl(t,e,r){var n=t._docCache.getLatestDocumentDataIfExists(e);return n?Promise.resolve({doc:t._docCache.getCachedRxDocuments([n])[0],inserted:!1}):t.findOne(e).exec().then(o=>o?{doc:o,inserted:!1}:t.insert(r).then(i=>({doc:i,inserted:!0})))}async function pl({database:t,name:e,schema:r,instanceCreationOptions:n={},migrationStrategies:o={},autoMigrate:i=!0,statics:s={},methods:a={},attachments:c={},options:l={},localDocuments:u=!1,cacheReplacementPolicy:h=ni,conflictHandler:f=di}){var d={databaseInstanceToken:t.token,databaseName:t.name,collectionName:e,schema:r.jsonSchema,options:n,multiInstance:t.multiInstance,password:t.password,devMode:j.isDevMode()};B("preCreateRxStorageInstance",d);var p=await nl(t,d),m=new en(t,e,r,p,n,o,a,c,l,h,s,f);try{await m.prepare(),Object.entries(s).forEach(([y,g])=>{Object.defineProperty(m,y,{get:()=>g.bind(m)})}),B("createRxCollection",{collection:m,creator:{name:e,schema:r,storageInstance:p,instanceCreationOptions:n,migrationStrategies:o,methods:a,attachments:c,options:l,cacheReplacementPolicy:h,localDocuments:u,statics:s}}),i&&m.schema.version!==0&&await m.migratePromise()}catch(y){throw zt.delete(m),await p.close(),y}return m}var gi=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;this._parallels=t||1,this._qC=0,this._iC=new Set,this._lHN=0,this._hPM=new Map,this._pHM=new Map};gi.prototype={isIdle:function(){return this._qC<this._parallels},lock:function(){this._qC++},unlock:function(){this._qC--,nn(this)},wrapCall:function(t){var e=this;this._qC++;var r;try{r=t()}catch(n){throw this.unlock(),n}return!r.then||typeof r.then!="function"?(this.unlock(),r):r.then(function(n){return e.unlock(),n}).catch(function(n){throw e.unlock(),n})},requestIdlePromise:function(t){var e=this;t=t||{};var r,n=new Promise(function(s){return r=s}),o=function(){rn(e,n),r()};if(n._manRes=o,t.timeout){var i=setTimeout(function(){n._manRes()},t.timeout);n._timeoutObj=i}return this._iC.add(n),nn(this),n},cancelIdlePromise:function(t){rn(this,t)},requestIdleCallback:function(t,e){var r=this._lHN++,n=this.requestIdlePromise(e);return this._hPM.set(r,n),this._pHM.set(n,r),n.then(function(){return t()}),r},cancelIdleCallback:function(t){var e=this._hPM.get(t);this.cancelIdlePromise(e)},clear:function(){var t=this;this._iC.forEach(function(e){return rn(t,e)}),this._qC=0,this._iC.clear(),this._hPM=new Map,this._pHM=new Map}};function ml(t){if(t._iC.size!==0){var e=t._iC.values(),r=e.next().value;r._manRes(),setTimeout(function(){return nn(t)},0)}}function rn(t,e){if(e){if(e._timeoutObj&&clearTimeout(e._timeoutObj),t._pHM.has(e)){var r=t._pHM.get(e);t._hPM.delete(r),t._pHM.delete(e)}t._iC.delete(e)}}function nn(t){t._tryIR||t._iC.size===0||(t._tryIR=!0,setTimeout(function(){if(!t.isIdle()){t._tryIR=!1;return}setTimeout(function(){if(!t.isIdle()){t._tryIR=!1;return}ml(t),t._tryIR=!1},0)},0))}class on{constructor(e){Ce(this,"ttl");Ce(this,"map",new Map);Ce(this,"_to",!1);this.ttl=e}has(e){return this.map.has(e)}add(e){this.map.set(e,bi()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,vl(this)},0))}clear(){this.map.clear()}}function vl(t){const e=bi()-t.ttl,r=t.map[Symbol.iterator]();for(;;){const n=r.next().value;if(!n)return;const o=n[0];if(n[1]<e)t.map.delete(o);else return}}function bi(){return Date.now()}var sn=new Set,wi=new Map,an=(function(){function t(r,n,o,i,s,a,c=!1,l={},u,h,f,d,p,m){this.idleQueue=new gi,this.rxdbVersion=qn,this.storageInstances=new Set,this._subs=[],this.startupErrors=[],this.onClose=[],this.closed=!1,this.collections={},this.states={},this.eventBulks$=new _t,this.closePromise=null,this.observable$=this.eventBulks$.pipe(ae(y=>go(y))),this.storageToken=$t,this.storageTokenDocument=$t,this.emittedEventBulkIds=new on(60*1e3),this.name=r,this.token=n,this.storage=o,this.instanceCreationOptions=i,this.password=s,this.multiInstance=a,this.eventReduce=c,this.options=l,this.internalStore=u,this.hashFunction=h,this.cleanupPolicy=f,this.allowSlowCount=d,this.reactivity=p,this.onClosed=m,this.name!=="pseudoInstance"&&(this.internalStore=Ho(this.asRxDatabase,u,Xr),this.storageTokenDocument=el(this.asRxDatabase).catch(y=>this.startupErrors.push(y)),this.storageToken=this.storageTokenDocument.then(y=>y.data.token).catch(y=>this.startupErrors.push(y)))}var e=t.prototype;return e.getReactivityFactory=function(){if(!this.reactivity)throw b("DB14",{database:this.name});return this.reactivity},e.$emit=function(r){this.emittedEventBulkIds.has(r.id)||(this.emittedEventBulkIds.add(r.id),this.eventBulks$.next(r))},e.removeCollectionDoc=async function(r,n){var o=await jc(this.internalStore,tn(hi(r,n),be));if(!o)throw b("SNH",{name:r,schema:n});var i=Xe(o);i._deleted=!0,await this.internalStore.bulkWrite([{document:i,previous:o}],"rx-database-remove-collection")},e.addCollections=async function(r){var n={},o={},i=[],s={};await Promise.all(Object.entries(r).map(async([l,u])=>{var h=l,f=u.schema;n[h]=f;var d=$s(f,this.hashFunction);if(o[h]=d,this.collections[l])throw b("DB3",{name:l});var p=hi(l,f),m={id:tn(p,be),key:p,context:be,data:{name:h,schemaHash:await d.hash,schema:d.jsonSchema,version:d.version,connectedStorages:[]},_deleted:!1,_meta:fr(),_rev:dr(),_attachments:{}};i.push({document:m});var y=Object.assign({},u,{name:h,schema:d,database:this}),g=T(u);g.database=this,g.name=l,B("preCreateRxCollection",g),y.conflictHandler=g.conflictHandler,s[h]=y}));var a=await this.internalStore.bulkWrite(i,"rx-database-add-collection");await wl(this),await Promise.all(a.error.map(async l=>{if(l.status!==409)throw b("DB12",{database:this.name,writeError:l});var u=P(l.documentInDb),h=u.data.name,f=o[h];if(u.data.schemaHash!==await f.hash)throw b("DB6",{database:this.name,collection:h,previousSchemaHash:u.data.schemaHash,schemaHash:await f.hash,previousSchema:u.data.schema,schema:P(n[h])})}));var c={};return await Promise.all(Object.keys(r).map(async l=>{var u=s[l],h=await pl(u);c[l]=h,this.collections[l]=h,this[l]||Object.defineProperty(this,l,{get:()=>this.collections[l]})})),c},e.lockedRun=function(r){return this.idleQueue.wrapCall(r)},e.requestIdlePromise=function(){return this.idleQueue.requestIdlePromise()},e.exportJSON=function(r){throw E("json-dump")},e.addState=function(r){throw E("state")},e.importJSON=function(r){throw E("json-dump")},e.backup=function(r){throw E("backup")},e.leaderElector=function(){throw E("leader-election")},e.isLeader=function(){throw E("leader-election")},e.waitForLeadership=function(){throw E("leader-election")},e.migrationStates=function(){throw E("migration-schema")},e.close=function(){if(this.closePromise)return this.closePromise;var{promise:r,resolve:n}=_i(),o=i=>{this.onClosed&&this.onClosed(),this.closed=!0,n(i)};return this.closePromise=r,(async()=>{if(await oe("preCloseRxDatabase",this),this.eventBulks$.complete(),this._subs.map(i=>i.unsubscribe()),this.name==="pseudoInstance"){o(!1);return}return this.requestIdlePromise().then(()=>Promise.all(this.onClose.map(i=>i()))).then(()=>Promise.all(Object.keys(this.collections).map(i=>this.collections[i]).map(i=>i.close()))).then(()=>this.internalStore.close()).then(()=>o(!0))})(),r},e.remove=function(){return this.close().then(()=>bl(this.name,this.storage,this.multiInstance,this.password))},at(t,[{key:"$",get:function(){return this.observable$}},{key:"asRxDatabase",get:function(){return this}}])})();function yl(t,e){if(sn.has(ki(t,e)))throw b("DB8",{name:t,storage:e.name,link:"https://rxdb.info/rx-database.html#ignoreduplicate"})}function _i(){var t,e,r=new Promise((n,o)=>{t=n,e=o});return{promise:r,resolve:t,reject:e}}function ki(t,e){return e.name+"|"+t}async function xi(t,e,r,n,o,i){var s=await e.createStorageInstance({databaseInstanceToken:t,databaseName:r,collectionName:Cc,schema:Xr,options:n,multiInstance:o,password:i,devMode:j.isDevMode()});return s}function gl({storage:t,instanceCreationOptions:e,name:r,password:n,multiInstance:o=!0,eventReduce:i=!0,ignoreDuplicate:s=!1,options:a={},cleanupPolicy:c,closeDuplicates:l=!1,allowSlowCount:u=!1,localDocuments:h=!1,hashFunction:f=Cn,reactivity:d}){B("preCreateRxDatabase",{storage:t,instanceCreationOptions:e,name:r,password:n,multiInstance:o,eventReduce:i,ignoreDuplicate:s,options:a,localDocuments:h});var p=ki(r,t),m=wi.get(p)||new Set,y=_i(),g=Array.from(m),w=()=>{m.delete(y.promise),sn.delete(p)};return m.add(y.promise),wi.set(p,m),(async()=>{if(l&&await Promise.all(g.map(k=>k.catch(()=>null).then(D=>D&&D.close()))),s){if(!j.isDevMode())throw b("DB9",{database:r})}else yl(r,t);sn.add(p);var _=Te(10),A=await xi(_,t,r,e,o,n),x=new an(r,_,t,e,n,o,i,a,A,f,c,u,d,w);return await oe("createRxDatabase",{database:x,creator:{storage:t,instanceCreationOptions:e,name:r,password:n,multiInstance:o,eventReduce:i,ignoreDuplicate:s,options:a,localDocuments:h}}),x})().then(_=>{y.resolve(_)}).catch(_=>{y.reject(_),w()}),y.promise}async function bl(t,e,r=!0,n){var o=Te(10),i=await xi(o,e,t,{},r,n),s=await ui(i),a=new Set;s.forEach(l=>a.add(l.data.name));var c=Array.from(a);return await Promise.all(c.map(l=>fi(e,i,o,t,l,r,n))),await oe("postRemoveRxDatabase",{databaseName:t,storage:e}),await i.remove(),c}async function wl(t){if(await t.storageToken,t.startupErrors[0])throw t.startupErrors[0]}var _l={RxSchema:Wn.prototype,RxDocument:tr,RxQuery:si.prototype,RxCollection:en.prototype,RxDatabase:an.prototype},cn=new Set,Oi=new Set;function kl(t){if(B("preAddRxPlugin",{plugin:t,plugins:cn}),!cn.has(t)){{if(Oi.has(t.name))throw b("PL3",{name:t.name,plugin:t});cn.add(t),Oi.add(t.name)}if(!t.rxdb)throw $e("PL1",{plugin:t});t.init&&t.init(),t.prototypes&&Object.entries(t.prototypes).forEach(([e,r])=>r(_l[e])),t.overwritable&&Object.assign(j,t.overwritable),t.hooks&&Object.entries(t.hooks).forEach(([e,r])=>{r.after&&ne[e].push(r.after),r.before&&ne[e].unshift(r.before)})}}function xl(t){return t&&typeof t.then=="function"}Promise.resolve(!1),Promise.resolve(!0);var Ht=Promise.resolve();function Ei(t,e){return t||(t=0),new Promise(function(r){return setTimeout(function(){return r(e)},t)})}function Ol(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function un(){return Math.random().toString(36).substring(2)}var ln=0;function we(){var t=Date.now()*1e3;return t<=ln&&(t=ln+1),ln=t,t}var El=we,Dl="native";function Il(t){var e={time:we(),messagesCallback:null,bc:new BroadcastChannel(t),subFns:[]};return e.bc.onmessage=function(r){e.messagesCallback&&e.messagesCallback(r.data)},e}function Pl(t){t.bc.close(),t.subFns=[]}function Sl(t,e){try{return t.bc.postMessage(e,!1),Ht}catch(r){return Promise.reject(r)}}function Cl(t,e){t.messagesCallback=e}function jl(){if(typeof globalThis<"u"&&globalThis.Deno&&globalThis.Deno.args)return!0;if((typeof window<"u"||typeof self<"u")&&typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}else return!1}function Rl(){return 150}var Ml={create:Il,close:Pl,onMessage:Cl,postMessage:Sl,canBeUsed:jl,type:Dl,averageResponseTime:Rl,microSeconds:El};function hn(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=JSON.parse(JSON.stringify(t));return typeof e.webWorkerSupport>"u"&&(e.webWorkerSupport=!0),e.idb||(e.idb={}),e.idb.ttl||(e.idb.ttl=1e3*45),e.idb.fallbackInterval||(e.idb.fallbackInterval=150),t.idb&&typeof t.idb.onclose=="function"&&(e.idb.onclose=t.idb.onclose),e.localstorage||(e.localstorage={}),e.localstorage.removeTimeout||(e.localstorage.removeTimeout=1e3*60),t.methods&&(e.methods=t.methods),e.node||(e.node={}),e.node.ttl||(e.node.ttl=1e3*60*2),e.node.maxParallelWrites||(e.node.maxParallelWrites=2048),typeof e.node.useFastPath>"u"&&(e.node.useFastPath=!0),e}var $l=we,Al="pubkey.broadcast-channel-0-",rt="messages",nr={durability:"relaxed"},ql="idb";function Di(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){if(typeof window.mozIndexedDB<"u")return window.mozIndexedDB;if(typeof window.webkitIndexedDB<"u")return window.webkitIndexedDB;if(typeof window.msIndexedDB<"u")return window.msIndexedDB}return!1}function fn(t){t.commit&&t.commit()}function Nl(t){var e=Di(),r=Al+t,n=e.open(r);return n.onupgradeneeded=function(o){var i=o.target.result;i.createObjectStore(rt,{keyPath:"id",autoIncrement:!0})},new Promise(function(o,i){n.onerror=function(s){return i(s)},n.onsuccess=function(){o(n.result)}})}function Tl(t,e,r){var n=Date.now(),o={uuid:e,time:n,data:r},i=t.transaction([rt],"readwrite",nr);return new Promise(function(s,a){i.oncomplete=function(){return s()},i.onerror=function(l){return a(l)};var c=i.objectStore(rt);c.add(o),fn(i)})}function Bl(t,e){var r=t.transaction(rt,"readonly",nr),n=r.objectStore(rt),o=[],i=IDBKeyRange.bound(e+1,1/0);if(n.getAll){var s=n.getAll(i);return new Promise(function(c,l){s.onerror=function(u){return l(u)},s.onsuccess=function(u){c(u.target.result)}})}function a(){try{return i=IDBKeyRange.bound(e+1,1/0),n.openCursor(i)}catch{return n.openCursor()}}return new Promise(function(c,l){var u=a();u.onerror=function(h){return l(h)},u.onsuccess=function(h){var f=h.target.result;f?f.value.id<e+1?f.continue(e+1):(o.push(f.value),f.continue()):(fn(r),c(o))}})}function Ll(t,e){if(t.closed)return Promise.resolve([]);var r=t.db.transaction(rt,"readwrite",nr),n=r.objectStore(rt);return Promise.all(e.map(function(o){var i=n.delete(o);return new Promise(function(s){i.onsuccess=function(){return s()}})}))}function Fl(t,e){var r=Date.now()-e,n=t.transaction(rt,"readonly",nr),o=n.objectStore(rt),i=[];return new Promise(function(s){o.openCursor().onsuccess=function(a){var c=a.target.result;if(c){var l=c.value;l.time<r?(i.push(l),c.continue()):(fn(n),s(i))}else s(i)}})}function Ql(t){return Fl(t.db,t.options.idb.ttl).then(function(e){return Ll(t,e.map(function(r){return r.id}))})}function Wl(t,e){return e=hn(e),Nl(t).then(function(r){var n={closed:!1,lastCursorId:0,channelName:t,options:e,uuid:un(),eMIs:new on(e.idb.ttl*2),writeBlockPromise:Ht,messagesCallback:null,readQueuePromises:[],db:r};return r.onclose=function(){n.closed=!0,e.idb.onclose&&e.idb.onclose()},Ii(n),n})}function Ii(t){t.closed||Pi(t).then(function(){return Ei(t.options.idb.fallbackInterval)}).then(function(){return Ii(t)})}function zl(t,e){return!(t.uuid===e.uuid||e.eMIs.has(t.id)||t.data.time<e.messagesCallbackTime)}function Pi(t){return t.closed||!t.messagesCallback?Ht:Bl(t.db,t.lastCursorId).then(function(e){var r=e.filter(function(n){return!!n}).map(function(n){return n.id>t.lastCursorId&&(t.lastCursorId=n.id),n}).filter(function(n){return zl(n,t)}).sort(function(n,o){return n.time-o.time});return r.forEach(function(n){t.messagesCallback&&(t.eMIs.add(n.id),t.messagesCallback(n.data))}),Ht})}function Hl(t){t.closed=!0,t.db.close()}function Kl(t,e){return t.writeBlockPromise=t.writeBlockPromise.then(function(){return Tl(t.db,t.uuid,e)}).then(function(){Ol(0,10)===0&&Ql(t)}),t.writeBlockPromise}function Ul(t,e,r){t.messagesCallbackTime=r,t.messagesCallback=e,Pi(t)}function Vl(){return!!Di()}function Jl(t){return t.idb.fallbackInterval*2}var Gl={create:Wl,close:Hl,onMessage:Ul,postMessage:Kl,canBeUsed:Vl,type:ql,averageResponseTime:Jl,microSeconds:$l},Yl=we,Zl="pubkey.broadcastChannel-",Xl="localstorage";function Si(){var t;if(typeof window>"u")return null;try{t=window.localStorage,t=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return t}function Ci(t){return Zl+t}function th(t,e){return new Promise(function(r){Ei().then(function(){var n=Ci(t.channelName),o={token:un(),time:Date.now(),data:e,uuid:t.uuid},i=JSON.stringify(o);Si().setItem(n,i);var s=document.createEvent("Event");s.initEvent("storage",!0,!0),s.key=n,s.newValue=i,window.dispatchEvent(s),r()})})}function eh(t,e){var r=Ci(t),n=function(o){o.key===r&&e(JSON.parse(o.newValue))};return window.addEventListener("storage",n),n}function rh(t){window.removeEventListener("storage",t)}function nh(t,e){if(e=hn(e),!ji())throw new Error("BroadcastChannel: localstorage cannot be used");var r=un(),n=new on(e.localstorage.removeTimeout),o={channelName:t,uuid:r,eMIs:n};return o.listener=eh(t,function(i){o.messagesCallback&&i.uuid!==r&&(!i.token||n.has(i.token)||i.data.time&&i.data.time<o.messagesCallbackTime||(n.add(i.token),o.messagesCallback(i.data)))}),o}function oh(t){rh(t.listener)}function ih(t,e,r){t.messagesCallbackTime=r,t.messagesCallback=e}function ji(){var t=Si();if(!t)return!1;try{var e="__broadcastchannel_check";t.setItem(e,"works"),t.removeItem(e)}catch{return!1}return!0}function sh(){var t=120,e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")?t*2:t}var ah={create:nh,close:oh,onMessage:ih,postMessage:th,canBeUsed:ji,type:Xl,averageResponseTime:sh,microSeconds:Yl},Ri=we,ch="simulate",dn=new Set;function uh(t){var e={time:Ri(),name:t,messagesCallback:null};return dn.add(e),e}function lh(t){dn.delete(t)}var Mi=5;function hh(t,e){return new Promise(function(r){return setTimeout(function(){var n=Array.from(dn);n.forEach(function(o){o.name===t.name&&o!==t&&o.messagesCallback&&o.time<e.time&&o.messagesCallback(e)}),r()},Mi)})}function fh(t,e){t.messagesCallback=e}function dh(){return!0}function ph(){return Mi}var mh={create:uh,close:lh,onMessage:fh,postMessage:hh,canBeUsed:dh,type:ch,averageResponseTime:ph,microSeconds:Ri},$i=[Ml,Gl,ah];function vh(t){var e=[].concat(t.methods,$i).filter(Boolean);if(t.type){if(t.type==="simulate")return mh;var r=e.find(function(o){return o.type===t.type});if(r)return r;throw new Error("method-type "+t.type+" not found")}t.webWorkerSupport||(e=e.filter(function(o){return o.type!=="idb"}));var n=e.find(function(o){return o.canBeUsed()});if(n)return n;throw new Error("No usable method found in "+JSON.stringify($i.map(function(o){return o.type})))}var Ai=new Set,yh=0,pn=function(t,e){this.id=yh++,Ai.add(this),this.name=t,this.options=hn(e),this.method=vh(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,gh(this)};pn._pubkey=!0,pn.prototype={postMessage:function(t){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(t));return qi(this,"message",t)},postInternal:function(t){return qi(this,"internal",t)},set onmessage(t){var e=this.method.microSeconds(),r={time:e,fn:t};Bi(this,"message",this._onML),t&&typeof t=="function"?(this._onML=r,Ti(this,"message",r)):this._onML=null},addEventListener:function(t,e){var r=this.method.microSeconds(),n={time:r,fn:e};Ti(this,t,n)},removeEventListener:function(t,e){var r=this._addEL[t].find(function(n){return n.fn===e});Bi(this,t,r)},close:function(){var t=this;if(!this.closed){Ai.delete(this),this.closed=!0;var e=this._prepP?this._prepP:Ht;return this._onML=null,this._addEL.message=[],e.then(function(){return Promise.all(Array.from(t._uMP))}).then(function(){return Promise.all(t._befC.map(function(r){return r()}))}).then(function(){return t.method.close(t._state)})}},get type(){return this.method.type},get isClosed(){return this.closed}};function qi(t,e,r){var n=t.method.microSeconds(),o={time:n,type:e,data:r},i=t._prepP?t._prepP:Ht;return i.then(function(){var s=t.method.postMessage(t._state,o);return t._uMP.add(s),s.catch().then(function(){return t._uMP.delete(s)}),s})}function gh(t){var e=t.method.create(t.name,t.options);xl(e)?(t._prepP=e,e.then(function(r){t._state=r})):t._state=e}function Ni(t){return t._addEL.message.length>0||t._addEL.internal.length>0}function Ti(t,e,r){t._addEL[e].push(r),bh(t)}function Bi(t,e,r){t._addEL[e]=t._addEL[e].filter(function(n){return n!==r}),wh(t)}function bh(t){if(!t._iL&&Ni(t)){var e=function(n){t._addEL[n.type].forEach(function(o){n.time>=o.time&&o.fn(n.data)})},r=t.method.microSeconds();t._prepP?t._prepP.then(function(){t._iL=!0,t.method.onMessage(t._state,e,r)}):(t._iL=!0,t.method.onMessage(t._state,e,r))}}function wh(t){if(t._iL&&!Ni(t)){t._iL=!1;var e=t.method.microSeconds();t.method.onMessage(t._state,null,e)}}var or=new Map;function _h(t,e,r,n){var o=or.get(e);return o||(o={bc:new pn(["RxDB:",t,r].join("|")),refs:new Set},or.set(e,o)),o.refs.add(n),o.bc}function Li(t,e){var r=or.get(t);if(r&&(r.refs.delete(e),r.refs.size===0))return or.delete(t),r.bc.close()}function kh(t,e,r,n){if(e.multiInstance){var o=_h(t,e.databaseInstanceToken,r.databaseName,r),i=new _t,s=f=>{f.storageName===t&&f.databaseName===e.databaseName&&f.collectionName===e.collectionName&&f.version===e.schema.version&&i.next(f.eventBulk)};o.addEventListener("message",s);var a=r.changeStream(),c=!1,l=a.subscribe(f=>{c||o.postMessage({storageName:t,databaseName:e.databaseName,collectionName:e.collectionName,version:e.schema.version,eventBulk:f})});r.changeStream=function(){return i.asObservable().pipe(ha(a))};var u=r.close.bind(r);r.close=async function(){return c=!0,l.unsubscribe(),o.removeEventListener("message",s),await Li(e.databaseInstanceToken,r),u()};var h=r.remove.bind(r);r.remove=async function(){return c=!0,l.unsubscribe(),o.removeEventListener("message",s),await Li(e.databaseInstanceToken,r),h()}}}var xh=new Map;function Oh(t,e){var r=G(xh,e,()=>new Map);function n(o){return G(r,JSON.stringify(o),()=>t(o))}return o=>Object.assign({},o.storage,{name:"validate-"+e+"-"+o.storage.name,async createStorageInstance(i){var s=await o.storage.createStorageInstance(i),a=bt(i.schema.primaryKey),c;bs(()=>c=n(i.schema));var l=s.bulkWrite.bind(s);return s.bulkWrite=(u,h)=>{c||(c=n(i.schema));var f=[],d=[];u.forEach(m=>{var y=m.document[a],g=c(m.document);g.length>0?f.push({status:422,isError:!0,documentId:y,writeRow:m,validationErrors:g,schema:s.schema}):d.push(m)});var p=d.length>0?l(d,h):Promise.resolve({error:[],success:[]});return p.then(m=>(f.forEach(y=>{m.error.push(y)}),m))},s}})}export{Es as A,Lr as B,zo as C,Nt as D,kh as E,gt as F,Xe as G,Rc as H,Tt as I,P as J,Ac as K,j as L,Mt as M,_r as N,Wt as O,Oh as P,kl as Q,en as R,_t as S,gl as T,an as a,tr as b,Vo as c,re as d,Rt as e,_n as f,ie as g,bt as h,Zt as i,$e as j,Ms as k,ks as l,kn as m,b as n,ee as o,Fr as p,Ln as q,Bn as r,qn as s,At as t,ps as u,wn as v,G as w,T as x,bn as y,es as z};
