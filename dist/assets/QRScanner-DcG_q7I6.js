var U=Object.defineProperty;var Q=(x,t,s)=>t in x?U(x,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):x[t]=s;var y=(x,t,s)=>Q(x,typeof t!="symbol"?t+"":t,s);import{j as e,y as T,F as z,z as F,X as H,u as $,H as O,L as W,c as B,I as V}from"./ui-BGfAbGa7.js";import{b as u}from"./vendor-BXttUi4B.js";import{e as S}from"./utils-DilR8ceW.js";import{w as m}from"./main-eP8YNJ4I.js";class K{constructor(t="http://localhost:3001"){y(this,"pendingPayments",new Map);y(this,"paymentHistory",[]);y(this,"baseUrl");this.baseUrl=t}parseQRCode(t){try{let s;try{const n=JSON.parse(t);if(this.isValidPaymentRequest(n))s=n;else throw new Error("Invalid payment request format")}catch{s=this.parsePaymentURI(t)}return s.expires&&Date.now()>s.expires?{success:!1,error:"Payment request has expired",rawData:t}:{success:!0,data:s,rawData:t}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Invalid QR code format",rawData:t}}}async processPayment(t){const s=Date.now(),n=this.generatePaymentId();try{this.pendingPayments.set(n,t);let r,i;switch(t.type){case"payment":{const o=await this.processRegularPayment(t);r=o.transactionId,i=o.receipt;break}case"skill_invocation":{const o=await this.processSkillInvocationPayment(t);r=o.transactionId,i=o.receipt;break}case"wallet_connect":{const o=await this.processWalletConnection(t);r=o.transactionId,i=o.receipt;break}case"agent_deploy":{const o=await this.processAgentDeployment(t);r=o.transactionId,i=o.receipt;break}default:throw new Error(`Unsupported payment type: ${t.type}`)}this.paymentHistory.push(i),this.pendingPayments.delete(n);const p=Date.now()-s;return{success:!0,transactionId:r,receipt:i,processingTime:p}}catch(r){this.pendingPayments.delete(n);const i=Date.now()-s;return{success:!1,error:r instanceof Error?r.message:"Payment processing failed",processingTime:i}}}async processRegularPayment(t){var i;if(!t.amount||!t.recipient)throw new Error("Amount and recipient are required for regular payments");const s={from:((i=m.getCurrentAccount())==null?void 0:i.address)||"",to:t.recipient,amount:t.amount,memo:t.memo,nrnAmount:t.nrnCost},n=await m.createTransaction(s),r={transactionId:n,type:"payment",amount:t.amount,nrnAmount:t.nrnCost,recipient:t.recipient,timestamp:new Date,status:"pending"};return{transactionId:n,receipt:r}}async processSkillInvocationPayment(t){var i,p,o;if(!t.skillId||!t.nrnCost)throw new Error("Skill ID and NRN cost are required for skill invocation");const s={skillId:t.skillId,skillName:t.skillName||t.skillId,nrnCost:t.nrnCost,parameters:((i=t.metadata)==null?void 0:i.parameters)||{},expectedOutput:((p=t.metadata)==null?void 0:p.expectedOutput)||{},timeout:((o=t.metadata)==null?void 0:o.timeout)||3e4},n=await m.invokeSkill(s),r={transactionId:n,type:"skill_invocation",amount:"0",nrnAmount:t.nrnCost,recipient:"skill_network",timestamp:new Date,status:"pending"};return{transactionId:n,receipt:r}}async processWalletConnection(t){const s=await m.connectWallet(),n=`connect_${Date.now()}`,r={transactionId:n,type:"wallet_connect",amount:"0",recipient:s.address,timestamp:new Date,status:"confirmed"};return{transactionId:n,receipt:r}}async processAgentDeployment(t){var i;if(!t.agentId||!t.nrnCost)throw new Error("Agent ID and NRN cost are required for agent deployment");const s={from:((i=m.getCurrentAccount())==null?void 0:i.address)||"",to:"agent_network",amount:"0",nrnAmount:t.nrnCost,memo:`Agent deployment: ${t.agentId}`},n=await m.createTransaction(s),r={transactionId:n,type:"agent_deploy",amount:"0",nrnAmount:t.nrnCost,recipient:"agent_network",timestamp:new Date,status:"pending"};return{transactionId:n,receipt:r}}async checkPaymentStatus(t){const s=this.paymentHistory.find(n=>n.transactionId===t);if(!s)return null;try{const n=await m.checkTransactionStatus(t);return s.status=n.status,s.blockHeight=n.blockHeight,s.gasUsed=n.gasUsed,s}catch(n){return console.error("Failed to check payment status:",n),s}}getPaymentHistory(){return[...this.paymentHistory]}getPendingPayments(){return Array.from(this.pendingPayments.values())}generatePaymentQR(t){return t.expires||(t.expires=Date.now()+600*1e3),t.sessionId||(t.sessionId=this.generateSessionId()),JSON.stringify(t)}isValidPaymentRequest(t){if(!t||typeof t!="object")return!1;const s=t;if(!s.type||!["payment","skill_invocation","wallet_connect","agent_deploy"].includes(s.type))return!1;switch(s.type){case"payment":return!!(s.amount&&s.recipient);case"skill_invocation":return!!(s.skillId&&s.nrnCost);case"wallet_connect":return!0;case"agent_deploy":return!!(s.agentId&&s.nrnCost);default:return!1}}parsePaymentURI(t){try{const s=new URL(t),n=new URLSearchParams(s.search);let r="payment";t.startsWith("knirv:skill")?r="skill_invocation":t.startsWith("knirv:agent")?r="agent_deploy":t.startsWith("knirv:connect")&&(r="wallet_connect");const i={type:r,amount:n.get("amount")||void 0,recipient:n.get("recipient")||n.get("to")||void 0,skillId:n.get("skill")||n.get("skillId")||void 0,skillName:n.get("skillName")||void 0,agentId:n.get("agent")||n.get("agentId")||void 0,nrnCost:n.get("nrn")||n.get("nrnCost")||void 0,memo:n.get("memo")||n.get("message")||void 0,sessionId:n.get("session")||void 0},p=n.get("expires");return p&&(i.expires=parseInt(p,10)),i}catch(s){throw new Error(`Invalid payment URI format: ${s instanceof Error?s.message:"Unknown error"}`)}}generatePaymentId(){return`payment_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}const L=new K;function M({onScan:x,onClose:t,isOpen:s}){const n=u.useRef(null),[r,i]=u.useState(null),[p,o]=u.useState(!1),[w,j]=u.useState(!1),[_,f]=u.useState(!1),[N,h]=u.useState(null),[c,g]=u.useState({step:"scanning"}),[v,q]=u.useState({nrn:"0",balance:"0"}),b=u.useCallback(async()=>{try{const l=m.getCurrentAccount();if(l){const a=await m.getAccountBalance(l.id);q({nrn:a.nrnBalance,balance:a.balance})}}catch(l){console.error("Failed to load user balance:",l)}},[]),k=u.useCallback(l=>{var a;try{const d=L.parseQRCode(l);if(!d.success){h(d.error||"Invalid QR code");return}((a=d.data)==null?void 0:a.type)==="payment"?g({step:"confirming",request:d.data}):x(l)}catch(d){console.error("QR scan error:",d),g({step:"error",error:d instanceof Error?d.message:"QR scan failed"})}},[x]),I=u.useCallback(async()=>{if(n.current)try{h(null),f(!0);const l=new S(n.current,d=>k(d.data),{highlightScanRegion:!0,highlightCodeOutline:!0,preferredCamera:"environment"}),a=await S.hasCamera();o(a),await l.start(),i(l),f(!1)}catch(l){console.error("Failed to initialize QR scanner:",l),h("Failed to access camera. Please check permissions."),f(!1)}},[k]);u.useEffect(()=>(s&&n.current&&(I(),b()),()=>{r&&r.destroy()}),[s,I,b,r]);const C=async()=>{var l;if(!c.request){h("Payment request not available");return}g(a=>({...a,step:"processing"}));try{const a=c.request;let d;if(a.type==="skill_invocation"&&a.skillId&&a.nrnCost)d=await m.invokeSkill({skillId:a.skillId,skillName:a.skillName||a.skillId,nrnCost:a.nrnCost,parameters:{},expectedOutput:{},timeout:3e4});else if(a.type==="payment"&&a.amount&&a.recipient){const E={from:((l=m.getCurrentAccount())==null?void 0:l.address)||"",to:a.recipient,amount:a.amount,memo:a.memo,nrnAmount:a.nrnCost};d=await m.createTransaction(E)}else throw new Error("Unsupported payment type");const A=await m.checkTransactionStatus(d);g({step:"success",request:a,transaction:A}),await b()}catch(a){console.error("Payment processing failed:",a),g({step:"error",request:c.request,error:a instanceof Error?a.message:"Payment failed"})}},P=()=>{g({step:"scanning"}),h(null)},D=async()=>{if(r&&p)try{j(!w),console.log("Flash toggle requested:",!w)}catch(l){console.error("Failed to toggle flash:",l)}},R=()=>{r&&(r.destroy(),i(null)),h(null),j(!1),t()};return s?e.jsxs("div",{className:"fixed inset-0 bg-black z-50 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-900 text-white",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(T,{size:20}),"Scan QR Code"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[p&&e.jsx("button",{onClick:D,className:"p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors",children:w?e.jsx(z,{size:20}):e.jsx(F,{size:20})}),e.jsx("button",{onClick:R,className:"p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors",children:e.jsx(H,{size:20})})]})]}),e.jsx("div",{className:"flex-1 relative",children:c.step==="scanning"?e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:n,className:"w-full h-full object-cover",playsInline:!0,muted:!0}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"w-64 h-64 border-2 border-white rounded-lg relative",children:[e.jsx("div",{className:"absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-blue-500 rounded-tl-lg"}),e.jsx("div",{className:"absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-blue-500 rounded-tr-lg"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-blue-500 rounded-bl-lg"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-blue-500 rounded-br-lg"}),_&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"})})]})})})]}):e.jsxs("div",{className:"flex-1 bg-gray-900 p-6 flex flex-col justify-center",children:[c.step==="confirming"&&c.request&&e.jsxs("div",{className:"max-w-md mx-auto w-full space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx($,{className:"w-16 h-16 mx-auto mb-4 text-blue-400"}),e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Confirm Payment"}),e.jsx("p",{className:"text-gray-400",children:"Review the payment details below"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"Type:"}),e.jsx("span",{className:"text-white capitalize",children:c.request.type.replace("_"," ")})]}),c.request.skillName&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"Skill:"}),e.jsx("span",{className:"text-white",children:c.request.skillName})]}),c.request.amount&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"Amount:"}),e.jsxs("span",{className:"text-white",children:[c.request.amount," KNIRV"]})]}),c.request.nrnCost&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"NRN Cost:"}),e.jsxs("span",{className:"text-yellow-400",children:[c.request.nrnCost," NRN"]})]}),c.request.recipient&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"To:"}),e.jsxs("span",{className:"text-white font-mono text-sm",children:[c.request.recipient.slice(0,20),"..."]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"text-gray-400",children:"Your Balance:"}),e.jsxs("span",{className:"text-white",children:[v.balance," KNIRV"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"NRN Balance:"}),e.jsxs("span",{className:"text-yellow-400",children:[v.nrn," NRN"]})]})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:P,className:"flex-1 py-3 px-4 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors",children:"Cancel"}),e.jsxs("button",{onClick:C,className:"flex-1 py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center space-x-2",children:[e.jsx(O,{className:"w-4 h-4"}),e.jsx("span",{children:"Confirm Payment"})]})]})]}),c.step==="processing"&&e.jsxs("div",{className:"max-w-md mx-auto w-full text-center space-y-6",children:[e.jsx(W,{className:"w-16 h-16 mx-auto text-blue-400 animate-spin"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Processing Payment"}),e.jsx("p",{className:"text-gray-400",children:"Please wait while we process your transaction..."})]})]}),c.step==="success"&&c.transaction&&e.jsxs("div",{className:"max-w-md mx-auto w-full text-center space-y-6",children:[e.jsx(B,{className:"w-16 h-16 mx-auto text-green-400"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Payment Successful"}),e.jsx("p",{className:"text-gray-400",children:"Your transaction has been processed"})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 text-left",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"text-gray-400",children:"Transaction ID:"}),e.jsx("span",{className:"text-white font-mono text-sm",children:c.transaction.id})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-400",children:"Status:"}),e.jsx("span",{className:"text-green-400",children:c.transaction.status})]})]}),e.jsx("button",{onClick:R,className:"w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors",children:"Done"})]}),c.step==="error"&&e.jsxs("div",{className:"max-w-md mx-auto w-full text-center space-y-6",children:[e.jsx(V,{className:"w-16 h-16 mx-auto text-red-400"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Payment Failed"}),e.jsx("p",{className:"text-gray-400",children:c.error||"An error occurred while processing your payment"})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:P,className:"flex-1 py-3 px-4 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors",children:"Back to Scanner"}),e.jsx("button",{onClick:C,className:"flex-1 py-3 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors",children:"Retry"})]})]})]})}),e.jsxs("div",{className:"p-4 bg-gray-900 text-white text-center",children:[e.jsx("p",{className:"text-sm",children:"Position the QR code within the frame to scan"}),N&&e.jsx("p",{className:"text-red-400 text-sm mt-2",children:N})]})]}):null}export{M as Q};
